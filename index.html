<html>
<head>
    <title>Predicting COVID-19</title>
    <script src="https://unpkg.com/regression@2.0.1/dist/regression.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.24.0/moment.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/df-number-format/2.1.6/jquery.number.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.2/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js"></script>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/fontawesome.min.css" rel="stylesheet" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/solid.min.css" rel="stylesheet" />
    <style type=text/css>
        .body-content { padding-top:10px; }
    @font-face {
        font-family: "FontAwesome";
        font-weight: normal;
        font-style : normal;
               src : url("https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/fonts/fontawesome-webfont.eot?v=4.3.0");
               src : url("https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/fonts/fontawesome-webfont.eot?#iefix&v=4.3.0") format("embedded-opentype"),
                     url("https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/fonts/fontawesome-webfont.woff2?v=4.3.0") format("woff2"),
                     url("https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/fonts/fontawesome-webfont.woff?v=4.3.0") format("woff"),
                     url("https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/fonts/fontawesome-webfont.ttf?v=4.3.0") format("truetype"),
                     url("https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/fonts/fontawesome-webfont.svg?v=4.3.0#fontawesomeregular") format("svg");
        }
        .alert {
            word-break:break-word;
        }
        h1, h2 {
            font-size: 45px;
            text-align: center;
            font-weight: normal;
        }
        #figures > div.col > span {
            padding:5px;
            display:block;
            padding:2px 0;
            margin:0 15px;
            border-bottom: solid 1px #ccc;
        }

        h2 {
            font-size: 50px;
        }
        h5 {
            font-size: 100%;
            white-space:nowrap;
        }
        #figures {
            font-size: 75%;
        }

        .sm {
            opacity: 0.6;
            white-space: nowrap;
        }

        body {
            font-size: 3em;
        }

        .tooltip {
            font-size: 88%;
        }

        .tooltip-inner {
            max-width: 600px;
        }

        @media (min-width:992px) {
            body {
                font-size: 1em;
            }

            .tooltip-inner {
                max-width: 200px;
            }
            #figures {
                font-size:90%;
            }

        }
    </style>
    <!--<script src="http://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>-->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sweetalert/2.1.2/sweetalert.min.js"></script>
    <script src="genetic/genetic.js"></script>
</head>
<body>
    <div class="container body-content">
        <div class="alert alert-info">
        <h1>Predicting COVID-19</h1>
            <p style=text-align:right;margin-bottom:0;margin-top:-20px>
                <button class="btn btn-info" href=# onclick="$('.collapse.show').removeClass('show').addClass('tmp');$('.collapse:not(.tmp)').addClass('show');$('.collapse.tmp').removeClass('tmp')">
                    MORE
                    <i class="fas fa-chevron-down"></i>
                </button>
            </p> <div class="collapse" id="collapseExample">
            <p>
              <b>Abstract</b>
            <p>
            <p>
            We apply mathematical model to real-time COVID statistics. Using that model, we predict 1) total number of cases 2) when infection peaks 3) when it returns back to zero. Prediction improves every day, as new data appear.
            <p>
              <b>Implementation Details</b>
            <p>
                We model COVID-19 epidemic growth as <a href="https://en.wikipedia.org/wiki/Gompertz_function">Gompertz function</a>. Precisely, we fit its <a href="https://www.geogebra.org/graphing/svpu7zdd">derivative</a> to reported cases. We then try to extrapolate beyond existing data. All processing happens on the client side. For curve fitting, we use <a href="https://github.com/subprotocol/genetic-js">genetic.js</a>. Data is being sourced from <a href="https://github.com/CSSEGISandData/COVID-19">Johns Hopkins CSSE GitHub Data Repository</a>. 
            <p>
              Current software is released under <a href="https://github.com/nosovicki/covid-19/blob/master/LICENSE">MIT license</a>.
              Your can contribute to the <a href="https://github.com/nosovicki/covid-19">source code</a> of this project.
            <p>
              <b>References</b>
            <p>
              <ol>
                <li>WHO - "Coronavirus disease 2019 (COVID-19) situation reports". 'https://www.who.int/emergencies/diseases/novel-coronavirus-2019/situation-reports'
                <li>Dong, Ensheng, Hongru Du, and Lauren Gardner. "An interactive web-based dashboard to track COVID-19 in real time." The Lancet Infectious Diseases (2020). Retrieved from: 'https://www.thelancet.com/journals/laninf/article/PIIS1473-3099(20)30120-1/fulltext'
                <li>Max Roser, Hannah Ritchie and Esteban Ortiz-Ospina (2020) - "Coronavirus Disease (COVID-19) â€“ Statistics and Research". Published online at OurWorldInData.org. Retrieved from: 'https://ourworldindata.org/coronavirus'
              </ol>
           </div>
        </div>
        <div class="row">
            <div class="col" style=min-width:700px;>
                <h2><span id=country></span> <span style=font-size:50%;white-space:nowrap><br><span style=color:red id=actual></span> <i title="Dataset actuality" class="fas fa-question-circle" style=color:red;opacity:.4;font-size:80%></i></h2>
                <div>
                    <canvas class=card id="scratch" style="width: 700px; height: 350px; cursor: normal;"></canvas>
                </div>
                <div class="progress" style=display:none;margin:10px>
                    <div class="progress-bar bg-info" role="progressbar" style="width: 1%;" aria-valuenow="1" aria-valuemin="0" aria-valuemax="100">1%</div>
                </div>
                <div class="row no-gutters" id=figures style=display:none>
                <div class=col>
                  <span class="flex-column align-items-start">
                    <div class="d-flex w-100 justify-content-between">
                      <h5 class="mb-1">
                        Observed yesterday
                        <i title="Confirmed number of infection cases yesterday" class="fas fa-question-circle text-secondary"></i>
                      </h5>
                    <div id=confirmed-yesterday></div>
                    </div>
                  </span>
                  <span class="flex-column align-items-start">
                    <div class="d-flex w-100 justify-content-between">
                      <h5 class="mb-1">
                        Observed total
                        <i title="Total number of confirmed cases in the dataset" class="fas fa-question-circle text-secondary"></i>
                      </h5>
                    <div id=confirmed-total></div>
                    </div>
                  </span>
                  <span class="flex-column align-items-start result">
                    <div class="d-flex w-100 justify-content-between">
                      <h5 class="mb-1">
                        Prognosed next week
                        <i title="Expected number of confirmed cases during next seven days" class="fas fa-question-circle text-secondary"></i>
                      </h5>
                      <span id=infected-next-week></span> <span class=sm>(+<span id=increase-next-week></span>%)</span>
                    </div>
                  </span>
                  <span class="flex-column align-items-start result">
                    <div class="d-flex w-100 justify-content-between">
                      <h5 class="mb-1">
                        Prognosed total
                        <i title="Projected total number of infections" class="fas fa-question-circle text-secondary"></i>
                      </h5>
                      <span id=infected></span> <span class=sm>(+<span id=increase></span>%)</span>
                    </div>
                  </span>
                  </div><div class=col>
                  <span class="flex-column align-items-start result">
                    <div class="d-flex w-100 justify-content-between">
                      <h5 class="mb-1">
                        <span id=peak-title></span>
                        <i title="Moment when new cases peak" class="fas fa-question-circle text-secondary"></i>
                      </h5>
                      <div id=peak></div>
                    </div>
                  </span>
                  <span class="flex-column align-items-start result">
                    <div class="d-flex w-100 justify-content-between">
                      <h5 class="mb-1">
                        <span id=end-title></span>
                        <i title="Moment when infection risk returns back to normal" class="fas fa-question-circle text-secondary"></i>
                      </h5>
                      <div id=days></div>
                    </div>
                  </span>
                  <span class="flex-column align-items-start result">
                    <div class="d-flex w-100 justify-content-between">
                      <h5 class="mb-1">
                        Model Error
                        <i title="Normalized mean prediction error" class="fas fa-question-circle text-secondary"></i>
                      </h5>
                      <div id=error></div>
                      <div id=confidence></div>
                    </div>
                  </span>
                  </div>
                </div>
                <hr>
                <div id=table></div>
            </div>
            <div class="col">
                <div class="alert alert-info">
                    <h2 style=text-align:center>
                        Data Source
                    </h2>
                    <select class=form-control style=font-size:1em;width:100% id=source onchange="sourceData($(this).val())">
                        <option value=jhu>JHU Daily Reports</option>
                        <option value=who>WHO Situation Reports</option>
                        <!--<option value=oxford>University of Oxford WHO</option>-->
                    </select>
                </div>
                <div>
                    <input style="font-family:FontAwesome,'Open Sans',Verdana,sans-serif;font-size:inherit" autocomplete=off id=search onfocus="$(this).val('');$('#menu a').show()" class="form-control" placeholder=" &#xf002; Search for your country" />
                </div>
                <div class="list-group auto-height" id=menu style=max-height:800px;min-height:250px;overflow-y:auto;min-width:135px></div>
            </div>
        </div>
        <div class=footer>
        </div>
    </div>
    <script>

        var graph = new Graph(document.getElementById("scratch"), 60, 10000);

        var genetic = Genetic.create();


        genetic.formula = {
            main: function (K, B, C, x) { return Math.pow(K, 2) * Math.exp(K * (1 - Math.exp(B * (C - x))) - B * (x - C) - K); },
            integral: function (K, B, C, x) { return (Math.exp(-Math.exp(B * (C - x)) * K) * K) / B; },
            centerPoint: function (K, B, C) { return (B * C - Math.log(1 / K)) / B; },
            startPoint: function (K, B, C) { return (B * C - Math.log(10 / K + 1 / 2000)) / B; },
            // x= (B*C-ln((1)/(500K)))/(B)
            endPoint: function (K, B, C) { return (B * C - Math.log(1 / 500 / K)) / B; },
        };

        genetic.optimize = Genetic.Optimize.Minimize;
        genetic.select1 = Genetic.Select1.Tournament2;
        genetic.select2 = Genetic.Select2.FittestRandom;

        genetic.seed = function () {

            var a = [];
            // create coefficients for polynomial with values between (-0.5, 0.5)

            var i;
            for (i = 0; i < this.userData["terms"]; ++i) {
                a.push(Math.random() - 0.01);
            }

            return [12000, 0.15, -15];
        };

        genetic.scale = [4000, 0.5, 5]

        genetic.mutate = function (entity) {

            // allow chromosomal drift with this range (-0.05, 0.05)

            var i = Math.floor(Math.random() * entity.length);
            var drift = ((Math.random() - 0.5) * 2) * genetic.scale[i];
            entity[i] += drift;

            return entity;
        };

        genetic.crossover = function (mother, father) {

            // crossover via interpolation
            function lerp(a, b, p) {
                return a + (b - a) * p;
            }

            var len = mother.length;
            var i = Math.floor(Math.random() * len);
            var r = Math.random();
            var son = [].concat(father);
            var daughter = [].concat(mother);

            son[i] = lerp(father[i], mother[i], r);
            daughter[i] = lerp(mother[i], father[i], r);

            return [son, daughter];
        };

        genetic.evaluate = function (coefficients, x, fn) {
            return fn(coefficients[0], coefficients[1], coefficients[2], x);
        }

        genetic.fitness = function (entity) {

            var sumSqErr = 0;
            var vertices = this.userData["vertices"];

            var i;
            for (i = 0; i < vertices.length; ++i) {
                var err = this.evaluate(entity, vertices[i][0], genetic.formula.main) - vertices[i][1];
                sumSqErr += err * err;
            }

            return Math.sqrt(sumSqErr);
        };

        genetic.generation = function (pop, generation, stats) {
        };

        genetic.notification = function (pop, generation, stats, isFinished) {

            function poly(entity) {
                var a = [];
                var i;
                for (i = entity.length - 1; i >= 0; --i) {
                    var buf = entity[i].toPrecision(2);
                    if (i > 1)
                        buf += "<em><b>x<sup>" + i + "<sup></b></em>";
                    else if (i == 1)
                        buf += "<em><b>x</b></em>";

                    a.push(buf);
                }
                return a.join(" + ");
            }

            function lerp(a, b, p) {
                return a + (b - a) * p;
            }

            if (generation == 0) {
                graph.solutions = [];
            }

            $("#solution").html(poly(pop[0].entity));
            $("#generation").html(generation + 1);
            var completion = Math.round((generation + 1) / 5) + '%';
            $('.progress-bar').css({ width: completion }).html(completion);
            $("#bestfit").html(pop[0].fitness.toPrecision(4))

            $("#vertexerror").html((pop[0].fitness / graph.vertices.length).toPrecision(4));

            ;
            $("#avgbestfit").html(stats.mean.toPrecision(4));
            $("#errorstdev").html(stats.stdev.toPrecision(4));


            var last = graph.last || "";

            var str = pop[0].entity.join(",");
            if (last != str || isFinished) {

                if (last != str) {
                    graph.solutions.push(pop[0].entity);
                    graph.last = str;
                }

                if (isFinished) {
                    var res = graph.solutions.pop();
                    res.push(genetic.formula.endPoint.apply(null, res));
                    window.solution = {
                        variables: res,
                        points: {
                            start: genetic.formula.startPoint.apply(null, res),
                            last: graph.vertices.length - 1,
                            current: currentPoint,
                            peak: genetic.formula.centerPoint.apply(null, res),
                            end: res[3]
                        },
                        total: genetic.formula.integral.apply(null, res)
                    }
                    zero = moment(dates[0]);
                    solution.dates = {
                        start: zero.clone().add(solution.points.start, 'days'),
                        peak: zero.clone().add(solution.points.peak, 'days'),
                        end: zero.clone().add(solution.points.end, 'days')
                    }
                    solution.nextWeek = genetic.formula.integral(res[0], res[1], res[2], solution.points.current + 7) - known;
                    solution.max = genetic.formula.main(res[0], res[1], res[2], solution.points.peak);
                    $('#end-title').text((solution.dates.end.isBefore(moment()) ? 'Observed' : 'Prognosed') + ' End');
                    $('#days').html(solution.dates.end.fromNow() + ' <span class=sm>' + solution.dates.end.format('DD MMM') + '</span>');
                    $('#peak-title').text((solution.dates.peak.isBefore(moment()) ? 'Observed' : 'Prognosed') + ' Peak');
                    $('#peak').html(solution.dates.peak.fromNow() + ' <span class=sm>' + solution.dates.peak.format('DD MMM') + '</span>');
                    $('#increase').number((solution.total - known) * 100 / known, 0, '.', ' ');
                    $('#infected').number(solution.total, 0, '.', ' ');
                    $('#infected-next-week').number(Math.max(0, solution.nextWeek), 0, '.', ' ');
                    $('#increase-next-week').number((solution.nextWeek) * 100 / known, 0, '.', ' ');
                    var empiricQualityGate = 1.103;
                    var observationLength = (Math.min(solution.points.last, solution.points.end) - solution.points.start);
                    var totalLength = (solution.points.end - solution.points.start);
                    var expError = pop[0].fitness / (graph.ymax / 2) / observationLength * totalLength;
                    solution.error = expError;
                    if (solution.total < 0)
                        return graph.refuse('Regression did not converge');
                    $('#confidence').html(expError > 1.29 ? '<span class="badge badge-danger">HIGH <i title="Model fits to data poorly. Prediction is highly speculative" class="fas fa-question-circle text-white"></i></span>' : expError > 1.03 ? '<span class="badge badge-warning">AVG <i title="Prediction quality cannot be reliably assessed" class="fas fa-question-circle text-white"></i></span>' : '<span class="badge badge-success">NORM <i title="Model follows data well. Prediction can be inconclusive due to lack of observation" class="fas fa-question-circle text-white"></i></span>');
                    $('#error').number(solution.error, 3);
                    //$('.progress').hide();
                    $('#figures').show();
                    var lineWidth = 3, strokeStyle = '#ffc107';
                    graph.drawFunction(graph.solutions[graph.solutions.length - 1], strokeStyle, lineWidth, genetic.formula.main);
                    $('.fa-question-circle').tooltip();
                    onResize();
                }
            }
        };




        function Graph(canvas, xmax, ymax) {
            this.canvas = document.getElementById("scratch");

            this.xmax = xmax;
            this.ymax = ymax;

            // canvas dimensions
            this.width = parseInt(canvas.style.width);
            this.height = parseInt(canvas.style.height);

            // retina
            var dpr = window.devicePixelRatio || 1;
            canvas.width = this.width * dpr;
            canvas.height = this.height * dpr;
            this.ctx = canvas.getContext("2d");
            this.ctx.scale(dpr, dpr);


            this.bound = [0, this.width - 1, this.height - 1, 0];

            this.bound[0] += 25;
            this.bound[1] -= 25;
            this.bound[2] -= 25;
            this.bound[3] += 50;

            this.vertices = [];
            this.solutions = [];
        }

        Graph.prototype.drawFunction = function (coefficients, strokeStyle, lineWidth, fn) {
            var ctx = this.ctx;
            ctx.save();
            var bound = this.bound;

            //ctx.setLineDash([1, 1]);
            ctx.strokeStyle = strokeStyle;
            var xmax = this.xmax;
            var ymax = this.ymax;
            var xstride = (bound[1] - bound[3]) / xmax;
            var ystride = (bound[2] - bound[0]) / ymax;
            var inc = 1 / xstride;

            ctx.lineWidth = lineWidth;

            ctx.beginPath();
            var x;
            for (x = 0; x < xmax; x += inc) {
                var cx = x * xstride + bound[3];
                var cy = bound[2] - genetic.evaluate(coefficients, x, fn) * ystride;

                if (x == 0) {
                    ctx.moveTo(cx, cy);
                } else {
                    ctx.lineTo(cx, cy);
                }
            }

            ctx.stroke();

            ctx.restore();
        }

        Graph.prototype.draw = function () {


            var ctx = this.ctx;
            ctx.save();
            var bound = this.bound;

            ctx.strokeStyle = "#000";
            ctx.fillStyle = "#000";
            ctx.clearRect(0, 0, this.width, this.height);

            var xmax = this.xmax;
            var ymax = this.ymax;
            var xstride = (bound[1] - bound[3]) / xmax;
            var ystride = (bound[2] - bound[0]) / ymax;


            var i;

            // x-grid
            //for (i=0;i<=xmax;++i) {
            for (i = 0; i <= xmax; i += Math.floor(xmax / 15)) {
                var cx = i * xstride + bound[3];
                var y = bound[2];

                ctx.strokeStyle = "#eee";
                ctx.beginPath();
                ctx.moveTo(cx, bound[0]);
                ctx.lineTo(cx, y);
                ctx.stroke();
            }

            // y-grid
            //for (i=0;i<=ymax;++i) {
            for (i = 0; i <= ymax; i += Math.floor(ymax / 10)) {
                var cx = bound[3];
                var y = bound[2] - i * ystride;
                ctx.beginPath();
                ctx.moveTo(cx, y);
                ctx.lineTo(bound[1], y);
                ctx.stroke();
            }


            // x/y bars
            ctx.beginPath();
            ctx.strokeStyle = "#bbb";
            ctx.moveTo(bound[3], bound[0]);
            ctx.lineTo(bound[3], bound[2]);
            ctx.lineTo(bound[1], bound[2]);
            ctx.lineWidth = 3;
            ctx.stroke();


            ctx.lineWidth = 1;
            var i;


            // x bars
            ctx.strokeStyle = "#000";
            for (i = 0; i <= xmax - 1; i += Math.floor(xmax / 8)) {
                var cx = i * xstride + bound[3];
                var y = bound[2];

                ctx.beginPath();
                ctx.moveTo(cx, y + 1);
                ctx.lineTo(cx, y + 5);
                ctx.stroke();

                ctx.font = "12px sans-serif";
                ctx.textAlign = "center";
                ctx.fillText(dates[i], cx, y + 16);
            }


            // y bars
            for (i = 0; i <= ymax; i += Math.floor(ymax / 10)) {
                var cx = bound[3];
                var y = bound[2] - i * ystride;
                ctx.beginPath();
                ctx.moveTo(cx, y);
                ctx.lineTo(cx - 4, y);
                ctx.stroke();

                ctx.font = "12px sans-serif";
                ctx.textAlign = "right";
                ctx.fillText(i, cx - 8, y + 4);
            }


            ctx.restore();
        };

        Graph.prototype.drawText = function (msg) {
            var ctx = this.ctx;
            var b = this.bound;
            ctx.font = "30px sans-serif";
            ctx.textAlign = "center";
            ctx.fillStyle = "#ccc";
            ctx.fillText(msg, (b[3] + b[1]) / 2, (b[2] + b[0]) / 2);
        }



        Graph.prototype.drawVertices = function () {

            var ctx = this.ctx;
            ctx.save();
            var bound = this.bound;

            var xmax = this.xmax;
            var ymax = this.ymax;
            var xstride = (bound[1] - bound[3]) / xmax;
            var ystride = (bound[2] - bound[0]) / ymax;

            var i;

            ctx.fillStyle = "#000";
            ctx.strokeStyle = "#fff";
            ctx.lineWidth = 2;

            // vertices
            for (i = 0; i < this.vertices.length; ++i) {
                var cx = this.vertices[i][0] * xstride + bound[3];
                var cy = bound[2] - this.vertices[i][1] * ystride;

                ctx.beginPath();
                ctx.arc(cx, cy, 3, 0, 2 * Math.PI);
                ctx.fill();
                ctx.stroke();
            }

            ctx.restore();
        };

    </script>
    <script type=text/javascript>
        $.expr[":"].contains = $.expr.createPseudo(function (arg) {
            return function (elem) {
                return $(elem).text().toUpperCase().indexOf(arg.toUpperCase()) >= 0;
            };
        });
        $.expr[":"].equals = $.expr.createPseudo(function (arg) {
            return function (elem) {
                return $(elem).text().toUpperCase() == arg.toUpperCase();
            };
        });
        var translate = { US: 'United States of America', 'Korea, South': 'South Korea', 'Republic of Korea': 'South Korea', 'Bahamas, The': 'Bahamas', 'Gambia, The': 'Gambia', 'Congo (Brazzaville)': 'Congo', 'Congo (Kinshasa)': 'Democratic Republic of Congo', 'Confirmed, China': 'China', 'Confirmed, Globally': 'World', 'Confirmed, Outside of China': 'Outside of China', 'Hubei , China': 'Hubei, China', 'Russia': 'Russian Federation' };
        search = function (ev) {
            var str = $(ev.target).val();
            if (str.length < 2) $('#menu a').show();
            $('#menu a').hide();
            $('#menu a:contains(' + str + ')').show();
        }
        var processCsvWHO = function (csv) {
            window.data = csv.split('\n').map(function (s) { return s.replace(/"([^,]+), ([^,]+)"/g, '$2 $1').split(','); });
            var titles = data.shift();
            window.cases = {};
            window.dates = titles.splice(3).map(function(s) { return moment(s, 'M/D/YYYY').format('YYYY-MM-DD'); });
            data.map(function (ls, i) {
                var last = 0;
                var title = (ls[0] ? (ls[0] + ', ') : '') + ls[1];
                if (ls[0] != 'Deaths')
                    cases[translate[title] || title] = ls.splice(3).map(function(x) { x = Math.max(parseInt(x) || last, last); var n = x - last; last = x; return n;});
            });
            window.data = csv.split('\n').map(function (s) { return s.replace(/"([^,]+), ([^,]+)"/g, '$2 $1').split(','); });
        };
        var processCsvJHU = function (csv) {
            window.data = csv.split('\n').map(function (s) { return s.replace(/"([^,]+), ([^,]+)"/g, '$2 $1').split(','); });
            var titles = data.shift();
            window.cases = { World:[] };
            window.dates = titles.splice(4).map(function(s) { return moment(s, 'M/D/YYYY').format('YYYY-MM-DD'); });
            data.map(function (ls, i) {
                var last = 0;
                var title = (ls[0] ? (ls[0] + ', ') : '') + ls[1];
                cases[translate[title] || title] = ls.splice(4).map(function(x, i) { x = Math.max(parseInt(x) || last, last); var n = x - last; last = x; cases.World[i] = (cases.World[i]||0) + n; return n;});
            });
            window.data = csv.split('\n').map(function (s) { return s.replace(/"([^,]+), ([^,]+)"/g, '$2 $1').split(','); });
        };
        var processCsv = function (csv) {
            window.data = csv.split('\n').map(function (s) { return s.split(','); });
            var titles = data.shift();
            window.cases = {};
            dates = [];
            titles.map(function (s) {
                cases[s] = [];
            })
            delete cases.date;
            data.map(function (ls, i) {
                ls.map(function (el, j) {
                    var title = titles[j];
                    if (title == 'date') dates.push(el);
                    else cases[title].push(el ? parseInt(el) : 0);
                });
            });
            while (!dates[dates.length - 1])
                dates.pop();
        };
        var processJson = function (res) {
            window.cases = { World: [] };
            dates = [];
            var start = true;
            Object.keys(res).sort().forEach(function(k) {
                var k2 = translate[k] || k;
                cases[k2] = [];
                var last = 0;
                for (var i = 0; i < res[k].length; ++i) {
                    var c = res[k][i];
                    var now = c.confirmed;
                    var diff = now - last;
                    cases[k2].push(diff);
                    if (start) {
                        cases.World.push(0);
                        dates.push(moment(res[k][i].date).format('YYYY-MM-DD'));
                    }
                    cases.World[i] += diff;
                    last = now;
                }
                start = false;
            });
        }

        var adjust = function (k, d) {
            var k2 = k + ' Adjusted';
            // approximate realistic figure for day d
            var approx = (cases[k][d - 1] + cases[k][d + 1]) / 2;
            // total cases before day d
            var x = 0.0; for (i = 0; i < d; ++i) x += cases[k][i];
            // add day d
            x += approx;
            var surplus = cases[k][d] - approx;
            var K = 1 + surplus / x;
            // distribute surplus proportionally between prior days
            cases[k2] = [];
            for (i = 0; i < d; ++i) cases[k2].push(cases[k][i] * K);
            // same for day d
            cases[k2].push(approx * K);
            // copy the rest
            for (i = d + 1; i < cases[k].length; ++i) cases[k2].push(cases[k][i]);
            cases[k] = cases[k2];
            delete cases[k2];
        }
        var spread = function (k, d) {
            // take next value and previous non-zero, and draw a line between them
            var nonZero = d;
            while (--nonZero > 0)
                if (cases[k][nonZero])
                    break;
            var n = (d - nonZero);
            var a = cases[k][nonZero];
            // (2 y - 2 a n)/(n^2 + n)
            var b = (2 * cases[k][d] - 2 * a * n) / (Math.pow(n,2) + n);
            while (++nonZero <= d)
                cases[k][nonZero] = (a += b);
        }
        graph.refuse = function (msg) {
            $('#sum').parent().show();
            $('#figures').show();
            $('.result').hide();
            graph.draw();
            graph.drawVertices();
            graph.drawText(msg);
        }
        var median = function(ar){
            for (var i = 0; i < ar.length; ++i){
                var cur = ar[i];
                var prev = ar[i-1] || cur;
                var next = ar[i+1] || cur;
                ar[i] = [cur[0], (prev[1] + next[1]) / 2];
            }
        }
        var estimate = function (country) {
            $('#country').html(country);
            $('.progress').show();
            $('#figures').hide();
            $('.result').show();
            graph.vertices = cases[country].map(function (c, i) { return [i, c]; });
            //median(graph.vertices);
            //median(graph.vertices);
            window.known = graph.vertices.reduce(function (a, b) { return a + b[1]; }, 0);
            window.currentPoint = moment().diff(moment(dates[0]), 'days')
            $('#confirmed-total').number(known, 0, '.', ' ');
            if (dates[currentPoint - 1])
                $('#confirmed-yesterday').number(graph.vertices[currentPoint - 1][1], 0, '.', ' ');
            else
                $('#confirmed-yesterday').html('<span style=color:red>No data <i title="The date is not present in the data source" class="fas fa-question-circle"></i></span>');
            var dataPoints = graph.vertices.reduce(function (a, b) { return a + (b[1] > 0); }, 0);
            $('#sum').number(known, 0, '.', ' ');
            if (known < 10 || dataPoints < 3)
                return graph.refuse('Insufficient number of observations');
            var ymax = graph.vertices.reduce(function (a, b) { return Math.max(a, b[1]); }, 0) * 2
            var scale = Math.floor(Math.log(ymax) / Math.log(10));
            var factor = Math.pow(10, scale);
            ymax = Math.round(ymax / factor) * factor;
            graph.xmax = graph.vertices.length;
            graph.ymax = Math.max(10, ymax);
            graph.draw();
            graph.drawText(country);
            graph.drawVertices();
            var config = { iterations: 500, size: 250, crossover: 0.4, mutation: 1.0, skip: 10 };
            var userData = { terms: 3, vertices: graph.vertices };
            $('h1')[0].scrollIntoView();
            genetic.evolve(config, userData);
        }
        var clickFn = function (el, k) {
            return function () {
                window.clicked = k;
                el.parent().find('.active').removeClass('active');
                el.addClass('active');
                estimate(k);
            }
        }
        $('#search').on('keyup', search);
        var initiateUI = function() {
            $('#actual').text(moment(dates[dates.length - 1]).add(1,'days').fromNow());
            $('#menu').html('');
            for (k in cases) {
                var el = $('<a class="list-group-item list-group-item-action" href=#>' + k + '</div>');
                el.on('click', clickFn(el, k));
                $('#menu').append(el);
            }
            if (window.clicked && $('#menu a:equals(' + clicked + ')').length)
                $($('#menu a:equals(' + clicked + ')')[0]).click();
            else
                $($('#menu a:equals(World)')[0]).click();
            if ($('#search').val())
                $('#search').keyup();
        }
        var sourceData = function(src) {
            if (src == 'who')
                $.get('https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/who_covid_19_situation_reports/who_covid_19_sit_rep_time_series/who_covid_19_sit_rep_time_series.csv').then(function (csv) {
                    processCsvWHO(csv);
                    adjust('China', 27);
                    // spread('Hubei, China', 11);
                    // adjust('Hubei, China', 24);
                    // spread('Guangdong, China', 11);
                    // spread('Henan, China', 11);
                    // spread('Zhejiang, China', 11);
                    // spread('Hunan, China', 11);
                    // spread('Anhui, China', 11);
                    // spread('Jiangxi, China', 11);
                    // spread('Shandong, China', 11);
                    // spread('Jiangsu, China', 11);
                    // spread('Chongqing, China', 11);
                    // spread('Sichuan, China', 11);
                    // spread('Heilongjiang, China', 11);
                    // spread('Beijing, China', 11);
                    // spread('Shanghai, China', 11);
                    // spread('Hebei, China', 11);
                    // spread('Fujian, China', 11);
                    // spread('Guangxi, China', 11);
                    // spread('Shaanxi, China', 11);
                    // spread('Yunnan, China', 11);
                    // spread('Hainan, China', 11);
                    // spread('Guizhou, China', 11);
                    // spread('Tianjin, China', 11);
                    // spread('Shanxi, China', 11);
                    // spread('Liaoning, China', 11);
                    // spread('Hong Kong, China', 11);
                    // spread('Jilin, China', 11);
                    // spread('Gansu, China', 11);
                    // spread('Xinjiang, China', 11);
                    // spread('Inner Mongolia, China', 11);
                    // spread('Ningxia, China', 11);
                    // spread('Taiwan, China', 11);
                    // spread('Qinghai, China', 11);
                    // spread('Macau, China', 11);
                    // spread('Xizang, China', 11);

                    delete cases['Hubei, China'];
                    delete cases['Guangdong, China'];
                    delete cases['Henan, China'];
                    delete cases['Zhejiang, China'];
                    delete cases['Hunan, China'];
                    delete cases['Anhui, China'];
                    delete cases['Jiangxi, China'];
                    delete cases['Shandong, China'];
                    delete cases['Jiangsu, China'];
                    delete cases['Chongqing, China'];
                    delete cases['Sichuan, China'];
                    delete cases['Heilongjiang, China'];
                    delete cases['Beijing, China'];
                    delete cases['Shanghai, China'];
                    delete cases['Hebei, China'];
                    delete cases['Fujian, China'];
                    delete cases['Guangxi, China'];
                    delete cases['Shaanxi, China'];
                    delete cases['Yunnan, China'];
                    delete cases['Hainan, China'];
                    delete cases['Guizhou, China'];
                    delete cases['Tianjin, China'];
                    delete cases['Shanxi, China'];
                    delete cases['Liaoning, China'];
                    delete cases['Hong Kong, China'];
                    delete cases['Jilin, China'];
                    delete cases['Gansu, China'];
                    delete cases['Xinjiang, China'];
                    delete cases['Inner Mongolia, China'];
                    delete cases['Ningxia, China'];
                    //delete cases['Taiwan, China'];
                    delete cases['Qinghai, China'];
                    //delete cases['Macau, China'];
                    delete cases['Xizang, China'];
                    delete cases["Unspecified*, China"];
                    initiateUI();
                }).fail(function () {
                    swal({ icon: 'error', content: $('<div>Error getting COVID-19 data from <i>raw.githubusercontent.com/CSSEGISandData</i></div>')[0], title: 'Network Error' });
                });
            else if (src == 'jhu')
                $.get('https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/time_series_covid19_confirmed_global.csv').then(function (csv) {
                    processCsvJHU(csv);
                    //adjust('China', 22);
                    //adjust('China', 23);
                    adjust('Hubei, China', 22);
                    spread('Hubei, China', 22);
                    adjust('Hubei, China', 23);
                    initiateUI();
                }).fail(function () {
                    swal({ icon: 'error', content: $('<div>Error getting COVID-19 data from <i>raw.githubusercontent.com/CSSEGISandData</i></div>')[0], title: 'Network Error' });
                });
            else if (src == 'oxford')
                $.get('https://cowid.netlify.com/data/new_cases.csv').then(function (csv) {
                    processCsv(csv);
                    adjust('China', 27);
                    adjust('World', 27);
                    initiateUI();
                }).fail(function () {
                    swal({ icon: 'error', content: $('<div>Error getting COVID-19 data from <i>ourworldindata.org</i></div>')[0], title: 'Network Error' });
                });
        }
        sourceData('jhu');
        var onResize = function () {
            var foot = $('.footer').height() + 20;
            $('.auto-height').css('height', function () {
                var off = $(this).offset();
                if (off) {
                    var h = $(window).height() - off.top - foot;
                    return h + 'px';
                }
            });
        }
        onResize();
        $(window).resize(onResize);
    </script>
</body>
</html>
