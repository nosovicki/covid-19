<html>
<head>
    <title>Predicting COVID-19</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.24.0/moment.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-loading-overlay/2.1.7/loadingoverlay.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/numeral.js/2.0.6/numeral.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.2/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js"></script>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/fontawesome.min.css" rel="stylesheet" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/solid.min.css" rel="stylesheet" />
    <style type=text/css>
    .navbar-brand {
        font-size: 0.9em;
        white-space:inherit;
    }
    .nav-link {font-size:0.6em;}
    .btn { font-size: 0.6em; }
    .ctry {
        background: whitesmoke;
        padding-top: 15px;
        border-top: solid 6px #dcdcdc;
    }
        .body-content { padding-top:10px; }
    @font-face {
        font-family: "FontAwesome";
        font-weight: normal;
        font-style : normal;
               src : url("https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/fonts/fontawesome-webfont.eot?v=4.3.0");
               src : url("https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/fonts/fontawesome-webfont.eot?#iefix&v=4.3.0") format("embedded-opentype"),
                     url("https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/fonts/fontawesome-webfont.woff2?v=4.3.0") format("woff2"),
                     url("https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/fonts/fontawesome-webfont.woff?v=4.3.0") format("woff"),
                     url("https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/fonts/fontawesome-webfont.ttf?v=4.3.0") format("truetype"),
                     url("https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/fonts/fontawesome-webfont.svg?v=4.3.0#fontawesomeregular") format("svg");
        }
        .alert {
            word-break:break-word;
        }
        .img-well {
            border: 1px solid #c8ccd1;
            padding: 3px;
            background-color: #f8f9fa;
            font-size: 94%;
            text-align: center;
            overflow: hidden;
        }
        h1, h3 {
            text-align: center;
            font-weight: normal;
        }
        #figures > div.col > span {
            padding:5px;
            display:block;
            padding:2px 0;
            margin:0 15px;
        }

        h3 { font-size:34px; }
        .dropdown-header {
            font-size: 100%!important;
        }
        h5 {
            font-size: 100%;
            white-space:nowrap;
            width: 53%;
            font-weight:normal;
        }
        #figures {
            font-size: 75%;
            line-height: 100%;
        }
        .dropdown-menu {
            font-size:100%;
        }
        #legend {
            display:none!important;
            font-size:90%;
        }
        #legend caption {
            font-size:90%;
            padding:0 0 0 0;
            white-space:nowrap;
        }
        #legend td {
            padding: 2px 2px;
            line-height: 85%;
            font-size: 85%;
        }
        #legend td i {
            font-size:90%;
        }

        .sm {
            opacity: 0.6;
            white-space: nowrap;
        }

        body {
            font-size: 3em;
        }

        .tooltip {
            font-size: 88%;
        }

        .tooltip-inner {
            max-width: 600px;
        }

        canvas {
            margin-left: auto;
            margin-right: auto;
            display:none;
            cursor: normal;
            margin-top:-10px;
        }
        canvas.show {
            display:block;
            cursor: pointer;
        }


	    @media (min-width: 768px) {
            .container {
                max-width: 864px;
            }
        }
        @media (min-width:992px) {
            .nav-link {font-size:1em;}
            .btn { font-size: 1em; }
            .navbar-brand {
                font-size: 1.25em;
            }
            canvas { display:block; }
            #legend { display:block!important; }
            .handle { display:none!important; }
            body {
                font-size: 1em;
            }

            .tooltip-inner {
                max-width: 200px;
            }
            #figures {
                font-size:90%;
            }
            .container {
                max-width: 960px;
            }
        }

        @media (min-width: 1200px) {.container { max-width: 1140px; } }
    </style>
    <!--<script src="http://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>-->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sweetalert/2.1.2/sweetalert.min.js"></script>
    <script src="genetic/genetic.js"></script>
    <script src="kalman/kalman.min.js" type="text/javascript"></script>
</head>
<body>
    <div class="container body-content">
        <div class="jumbotron" style="margin-bottom:0;padding:20px 30px 5px 30px">
        <h1>Predicting COVID-19</h1>
            <p><i><b>Warning:</b> this software is experimental. For a professional forecast, see <a href="https://covid19.healthdata.org/united-states-of-america">COVID-19 Projections</a> from <a href="http://www.healthdata.org/">IHME</a></i><p>
            <p>
            <p style=text-align:right;margin-bottom:0;margin-top:-20px>
                <button class="btn btn-info" href=# onclick="$('.collapse.show').removeClass('show').addClass('tmp');$('.collapse:not(.tmp)').addClass('show');$('.collapse.tmp').removeClass('tmp')">
                    MORE
                    <i class="fas fa-chevron-down"></i>
                </button>
            </p> <div class="collapse" id="more">
              <b>Abstract</b>
              <p>
	      The project explores predictive properties of <span style=font-size:150%;font-family:seriff>&int;e<sup>f(x)-g(x)</sup></span> type of functions by applying them to real-time COVID statistics. The software fits a model to a time-series of daily confirmed cases and predicts 1) final number of cases in a wave 2) when the wave peaks 3) when it returns back to zero. 
            <p>To assess prediction power, program offers retrospective analysis of predictions against observed values.
            <p>Similarly, the program creates country-specific models by parameterizing <a href=https://www.geogebra.org/graphing/uj89yxhz>SIR-like model</a> to fit a particular dataset. This way user can extend given set of models with any number of custom ones.
            <p>
              <b>Implementation Details</b>
            <p>
                We model COVID-19 growth as either <a href="https://www.geogebra.org/graphing/svpu7zdd">Gompertz function</a>, simple logistic <a href="https://www.geogebra.org/graphing/sk8vnujk">S-curve</a>, <a href="https://www.geogebra.org/graphing/kajd5hra">Generalized logistic curve</a>, or parameterized <a href=https://www.geogebra.org/graphing/uj89yxhz>SIR-like model</a>. In all cases, we fit the derivative to reported numbers and extrapolate beyond existing data. All processing happens on the client side. For curve fitting, we use <a href="https://github.com/subprotocol/genetic-js">genetic.js</a>. Data is being sourced from <a href="https://github.com/CSSEGISandData/COVID-19">Johns Hopkins CSSE GitHub Data Repository</a> and <a href="https://github.com/nytimes/covid-19-data">New York Times GitHub Data Repository</a>. 
            <p>
              The software is released under <a href="https://github.com/nosovicki/covid-19/blob/master/LICENSE">MIT license</a>.
              Your can contribute to the <a href="https://github.com/nosovicki/covid-19">source code</a> of the project.
            <p>
              <b>References</b>
            <p>
              <ol>
                <li>WHO - "Coronavirus disease 2019 (COVID-19) situation reports". 'https://www.who.int/emergencies/diseases/novel-coronavirus-2019/situation-reports'
                <li>Dong, Ensheng, Hongru Du, and Lauren Gardner. "An interactive web-based dashboard to track COVID-19 in real time." The Lancet Infectious Diseases (2020). Retrieved from: 'https://www.thelancet.com/journals/laninf/article/PIIS1473-3099(20)30120-1/fulltext'
                <li>Max Roser, Hannah Ritchie and Esteban Ortiz-Ospina (2020) - "Coronavirus Disease (COVID-19) â€“ Statistics and Research". Published online at OurWorldInData.org. Retrieved from: 'https://ourworldindata.org/coronavirus'
              </ol>
           </div>
        </div>
        <nav class="navbar navbar-expand-sm bg-dark navbar-dark justify-content-between" style=margin-bottom:10px>
  <a class="navbar-brand"><span id=country></span> <span style=font-size:80% class=sm><span class=actual></span> <i title="Dataset actuality" class="fas fa-question-circle"></i></small></a>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#collapsibleNavbar">
    <span class="navbar-toggler-icon"></span>
  </button>
  <div class="collapse navbar-collapse" id="collapsibleNavbar">
    <ul class="navbar-nav">
    <!--
      <li class="nav-item">
        <a class="nav-link active" href="index.html">Forecast</a>
      </li>
      -->
      <li class="nav-item" id=noise>
          <div class="dropdown">
              <a class="nav-link dropdown-toggle" data-toggle="dropdown" href="#">Data noise reduction</a>
              <div class="dropdown-menu">
                  <h6 class="dropdown-header">Noise Reduction</h6>
                  <a class="dropdown-item denoise-none" onclick="setNoise('none');return false" href="#"><i class="fas fa-tint-slash"></i> Off <i title="Don't streamline the data. Sometimes required" class="fas fa-question-circle"></i></a>
                  <a class="dropdown-item denoise-slight" onclick="setNoise('slight');return false" href="#"><i class="fas fa-star-half"></i> Slight <i title="Reveals small patterns in the data with minimal impact on prediction results. May cause inaccuracy" class="fas fa-question-circle"></i></a>
                  <a class="dropdown-item denoise-full" onclick="setNoise('full');return false" href="#"><i class="fas fa-tint"></i> Full <i title="Eliminates excessive data fluctuation. Often improves prediction accuracy." class="fas fa-question-circle"></i></a>
                  <a style=display:none class="dropdown-item denoise-extra" onclick="setNoise('extra');return false" href="#"><i class="fas fa-tint"></i> Extra <i title="Eliminates excessive data fluctuation. Often improves prediction accuracy." class="fas fa-question-circle"></i></a>
              </div>
          </div>
      </li>
      <li class="nav-item" id=method>
          <div class="dropdown">
              <a style=color:#00d0ff class="nav-link dropdown-toggle" data-toggle="dropdown" href="#">Advanced</a>
              <div class="dropdown-menu">
                  <h6 class="dropdown-header">Models</h6>
                  <a class="dropdown-item" onclick="setModel('gompertz');return false" href="#">Gompertz <i title="Best for small, cohesive geographic areas" class="fas fa-question-circle"></i></a>
                  <a class="dropdown-item" onclick="setModel('logistic');return false" href="#">Standard logistic <i title="Produces misleading results as a rule" class="fas fa-question-circle"></i></a>
                  <a class="dropdown-item" onclick="setModel('genlog');return false" href="#">Generalized Logistic <i title="Best for aggregated geographic areas" class="fas fa-question-circle"></i></a>
                  <!--<a class="dropdown-item" onclick="setModel('genlog2');return false" href="#">Generalized Logistic 2 <i title="Best for aggregated geographic areas" class="fas fa-question-circle"></i></a>-->
                  <div class="dropdown-divider"></div>
                  <a class="dropdown-item text-primary" onclick="trainFrom2(clicked);return false" href="#">Generate country-specific model <i title="Create a model that fits current time series best" class="fas fa-question-circle"></i></a>
                  <a class="dropdown-item text-primary" onclick="loadModel2();return false" href="#">Load model <i title="Load custom model" class="fas fa-question-circle"></i></a>
              </div>
          </div>
      </li>
  </ul>
  <ul class="navbar-nav">
      <li class="nav-item" id=sample style=display:none>
          <div class="dropdown">
              <a class="btn btn-secondary nav-link dropdown-toggle" data-toggle="dropdown" href="#">ANALYSE</a>
              <div class="dropdown-menu">
                  <h6 class="dropdown-header">Retrospective Analysis</h6>
                  <a class="dropdown-item" onclick="analyse(function () { plotDuration(); });return false" href="#">Duration estimate <i title="Analyse duration projections" class="fas fa-question-circle"></i></a>
                  <a class="dropdown-item" onclick="analyse(function () { plotTolerance(currentSource, clicked, 7); });return false" href="#">7-day prediction <i title="Next week increase, forecasted to actual juxtaposition" class="fas fa-question-circle"></i></a>
                  <a class="dropdown-item" onclick="analyse(function () { plotTolerance(currentSource, clicked, 30); });return false" href="#">30-day prediction <i title="Next month increase, forecasted to actual juxtaposition" class="fas fa-question-circle"></i></a>
                  <a class="dropdown-item" onclick="analyse();return false" href="#">Overall prediction <i title="Compare all earlier forecasts to current one" class="fas fa-question-circle"></i></a>
              </div>
          </div>
      </li>
      <!--
      <li class="nav-item">
          <a class="nav-link" href="results.html">Results</a>
      </li>
      <button class="btn btn-link" onclick="sampleAll();return false">Sample all</button>
      -->
  </ul>
  </div>
      <div class="dropdown" id=source>
          <a class="btn btn-secondary nav-link dropdown-toggle" data-toggle="dropdown" href="#">No Datasource</a>
          <div class="dropdown-menu">
            <a class="dropdown-item jhu" href=# onclick="sourceData('jhu');return false">World, JHU <i title="Johns Hopkins University CSSE daily reports (updated daily)" class="fas fa-question-circle"></i></a>
            <a class="dropdown-item who" href=# onclick="sourceData('who');return false">World, WHO <i title="WHO Situational Reports (updated twice a week)" class="fas fa-question-circle"></i></a>
            <a class="dropdown-item nyt" href=# onclick="sourceData('nyt');return false">States, NYT <i title="US situation by state, from New Your Times" class="fas fa-question-circle"></i></a>
            <a class="dropdown-item nytc" href=# onclick="sourceData('nytc');return false">Counties, NYT <i title="US situation by county, from New Your Times" class="fas fa-question-circle"></i></a>
        </div>
    </div>
</nav>
        <div class="row">
            <div class="col" style=min-width:742px;>
                <div style=text-align:center>
                    <canvas onclick="$('canvas, #legend').removeClass('show');$('.handle').show()" id="scratch" style="width: 700px; height: 350px;background:#fff"></canvas>
                    <button class="btn btn-info handle" onclick="$('canvas, #legend').addClass('show');$(this).hide();">DISPLAY GRAPHIC</button>
                </div>
                <div class="progress" style=display:none;margin:10px>
                    <div class="progress-bar bg-info" role="progressbar" style="width: 1%;" aria-valuenow="1" aria-valuemin="0" aria-valuemax="100">1%</div>
                </div>
                <div class="row no-gutters" id=figures style=display:none>
                <div class="col">
                  <span class="flex-column align-items-start">
                    <div class="d-flex w-100 justify-content-between">
                      <h5 class="mb-1 d-flex justify-content-between">
                        Observed cases
                        <i title="Total number of confirmed cases in the dataset" class="fas fa-question-circle text-secondary"></i>
                      </h5>
                    <div id=confirmed-total></div>
                    <span class="sm actual"></span>
                    </div>
                  </span>
                  <span class="flex-column align-items-start">
                    <div class="d-flex w-100 justify-content-between">
                      <h5 class="mb-1 d-flex justify-content-between">
                        Observed yesterday
                        <i title="Confirmed number of infection cases yesterday" class="fas fa-question-circle text-secondary"></i>
                      </h5>
                      <div id=confirmed-yesterday></div>
                      <span class=sm id=date-yesterday></span>
                    </div>
                  </span>
                  <span class="flex-column align-items-start result">
                    <div class="d-flex w-100 justify-content-between">
                      <h5 class="mb-1 d-flex justify-content-between">
                        Expected today
                        <i title="Expected range of confirmed cases today, 95% confidence" class="fas fa-question-circle text-secondary"></i>
                      </h5>
                      <div id=fr-today></div>-<div id=to-today></div> <span class=sm>(<i id=sign></i><span id=today-increase></span>%)
                    </div>
                  </span>
                  <span class="flex-column align-items-start result">
                    <div class="d-flex w-100 justify-content-between">
                      <h5 class="mb-1 d-flex justify-content-between">
                        + Next week
                        <i title="Expected range of new confirmed cases during next seven days, 95% confidence" class="fas fa-question-circle text-secondary"></i>
                      </h5>
                       <span id=fr-next-week></span>-<span id=to-next-week></span> <span class=sm>(x<span id=increase-next-week></span>)</span>
                    </div>
                  </span>
                  <span class="flex-column align-items-start result">
                    <div class="d-flex w-100 justify-content-between">
                      <h5 class="mb-1 d-flex justify-content-between">
                        + Next month
                        <i title="Expected range of new confirmed cases during next 30 days, 95% confidence" class="fas fa-question-circle text-secondary"></i>
                      </h5>
                       <span id=fr-next-month></span>-<span id=to-next-month></span> <span class=sm>(x<span id=increase-next-month></span>)</span>
                    </div>
                  </span>
                  <span class="flex-column align-items-start result font-weight-bold">
                    <div class="d-flex w-100 justify-content-between">
                      <h5 class="mb-1 d-flex justify-content-between">
			Expected Overall
                        <i title="Projected total number of confirmed cases, 95% confidence" class="fas fa-question-circle text-secondary"></i>
                      </h5>
                      <span class=text-success id=fr-total></span>-<span class=text-danger id=to-total></span> <span class=sm>(x<span id=increase></span>)</span>
                    </div>
                  </span>
                  </div><div class="col" style=min-width:50%>
                  <span class="flex-column align-items-start result">
                    <div class="d-flex w-100 justify-content-between">
                      <h5 class="mb-1 d-flex justify-content-between">
                        Observed Start
                        <i title="Moment when exponential growth started" class="fas fa-question-circle text-secondary"></i>
                      </h5>
                      <div id=start></div>
                    </div>
                  </span>
                  <span class="flex-column align-items-start result">
                    <div class="d-flex w-100 justify-content-between">
                      <h5 class="mb-1 d-flex justify-content-between">
                        <span id=peak-title></span>
                        <i title="Moment when new cases peak" class="fas fa-question-circle text-secondary"></i>
                      </h5>
                      <div id=peak></div>
                    </div>
                  </span>
                  <span class="flex-column align-items-start result">
                    <div class="d-flex w-100 justify-content-between">
                      <h5 class="mb-1 d-flex justify-content-between">
                        <span id=end-title></span>
                        <i title="Moment when infection risk returns back to normal" class="fas fa-question-circle text-secondary"></i>
                      </h5>
                      <div id=days></div>
                    </div>
                  </span>
                  <!--
                  <span class="flex-column align-items-start result">
                    <div class="d-flex w-100 justify-content-between">
                      <h5 class="mb-1 d-flex justify-content-between">
                        Correlation
                        <i title="Relation of modelled to known figures" class="fas fa-question-circle text-secondary"></i>
                      </h5>
                      <div id=correlation></div>
                      <div id=retro></div>
                    </div>
                  -->
                  <span class="flex-column align-items-start result">
                    <div class="d-flex w-100 justify-content-between">
                      <h5 class="mb-1 d-flex justify-content-between">
                        <span id=length-title></span>
                        <i title="Length of current epidemic wave, days" class="fas fa-question-circle text-secondary"></i>
                      </h5>
                      <div id=length></div>
                    </div>
                  </span>
                  <span class="flex-column align-items-start result">
                    <div class="d-flex w-100 justify-content-between">
                      <h5 class="mb-1 d-flex justify-content-between">
                        Model error
                        <i title="Magnitude of model error vector" class="fas fa-question-circle text-secondary"></i>
                      </h5>
                      <div id=model-error></div>
                      <div id=model-error-rank></div>
                    </div>
                  </span>
                  <span class="flex-column align-items-start result">
                    <div class="d-flex w-100 justify-content-between">
                      <h5 class="mb-1 d-flex justify-content-between">
                        Uncertainty
                        <i title="Relative standard deviation value of prediction" class="fas fa-question-circle text-secondary"></i>
                      </h5>
                      <div id=sigma></div>
                      <div id=sigma-rank></div>
                    </div>
                  </span>
                  </div>
                </div>
            </div>
            <div class="col">
                <div style="padding-bottom:5px;">
                    <input style="font-family:FontAwesome,'Open Sans',Verdana,sans-serif;font-size:inherit" autocomplete=off id=search onfocus="$(this).val('');$('#menu a').show()" class="form-control" placeholder=" &#xf002; Search for your country" />
                </div>
                <div class="list-group auto-height" id=menu style=max-height:800px;min-height:250px;overflow-y:auto;min-width:135px></div>
            </div>
        </div>
        <div class=footer>
        </div>
    </div>
    <script>
$.LoadingOverlaySetup({textColor: '#b3b3b3', imageColor: '#ccc', progressColor:'#17a2b8'});
        var graph = new Graph(document.getElementById("scratch"), 60, 10000);

        var genetic = Genetic.create();

        var denoiseLevel = { none: 0, slight: 1, full: 10, extra: 40 };

        var models = {
            sir: {
                variables:7,
                seed:  function () { return [4, 0.6, -1.5, 3, 5600, 26, 80]; },
                scale: [4, 0.6, -1.5, 3, 5600, 26, 80].map(function (x) {return Math.abs(x/3); }),
                iterations:2500,
                formula: {
                    main: function (A, B, C, D, K, L, M, x) {
                        return K*Math.exp(((x-M)/(L))*((B-A)/(Math.exp(-D*((x-M)/(L)-C))+1)+A-1));
                    },
                    integral: function (A, B, C, D, K, L, M, x) {
                        var ar = [];
                        for (i = 0; i <= x; ++i) {
                            ar.push(models.sir.formula.main(A, B, C, D, K, L, M, x));
                        }
                        return ar.reduce(function(a,b){ return a+b; },0);
                    },
                    centerPoint:function (A, B, C, D, K, L, M) {
                        var prev = -Infinity;
                        for (let x = -100; x < 200; ++x) {
                            var y = models.sir.formula.main(A, B, C, D, K, L, M, x);
                            if (y < prev)
                                return x - 1;
                            prev = y;
                        }
                    },
                    startPoint:function (A, B, C, D, K, L, M) {
                        for (var x = models.sir.formula.centerPoint(A, B, C, D, K, L, M); x > -1000; --x)
                            if (models.sir.formula.main(A, B, C, D, K, L, M, x) < 1)
                                return x + 1;
                        return NaN;
                    },
                    endPoint:function (A, B, C, D, K, L, M) {
                        for (var x = models.sir.formula.centerPoint(A, B, C, D, K, L, M); x < 2000; ++x)
                            if (models.sir.formula.main(A, B, C, D, K, L, M, x) < 1)
                                return x - 1;
                        return NaN;
                    },
                },
                html: 'Trn',
            },
            sirTrained: {
                variables:3,
                //seed:  function () { return [5600, 26, 80]; },
                //scale: models.sirTrained.seed().map(function (x) {return Math.abs(x/3); }),
                iterations:500,
                formula: {
                    main: function (K, L, M, x) {
                        var A=aval, B=bval, C=cval, D=dval; 
                        return K*Math.exp(((x-M)/(L))*((B-A)/(Math.exp(-D*((x-M)/(L)-C))+1)+A-1));
                    },
                    integral: function (K, L, M, x) {
                        var ar = [];
                        for (i = 0; i <= x; ++i) {
                            ar.push(models['mname'].formula.main(K, L, M, i));
                        }
                        return ar.reduce(function(a,b){ return a+b; },0);
                    },
                    centerPoint:function (K, L, M) {
                        var prev = -Infinity;
                        for (let x = -100; x < 200; ++x) {
                            var y = models['mname'].formula.main(K, L, M, x);
                            if (y < prev)
                                return x - 1;
                            prev = y;
                        }
                    },
                    startPoint:function (K, L, M) {
                        for (var x = models['mname'].formula.centerPoint(K, L, M); x > -1000; --x)
                            if (models['mname'].formula.main(K, L, M, x) < 1)
                                return x + 1;
                        return NaN;
                    },
                    endPoint:function (K, L, M) {
                        for (var x = models['mname'].formula.centerPoint(K, L, M); x < 2000; ++x)
                            if (models['mname'].formula.main(K, L, M, x) < 1)
                                return x - 1;
                        return NaN;
                    },
                },
                html: 'e<sup>f(x)-g(x)</sup>',
            },
            gompertz : {
                variables: 3,
                formula : {
                    main: function (K, B, C, x) { return Math.pow(K, 2) * Math.exp(K * (1 - Math.exp(B * (C - x))) - B * (x - C) - K); },
                    integral: function (K, B, C, x) { return (Math.exp(-Math.exp(B * (C - x)) * K) * K) / B; },
                    centerPoint: function (K, B, C) { return (B * C - Math.log(1 / K)) / B; },
                    startPoint: function (K, B, C) { return (-Math.log((Math.log((K)/(B)))/(K))+B*C)/B; },
                    endPoint: function (K, B, C) { return (B * C - Math.log(1 / 500 / K)) / B; },
                },
                seed:  function () { return [12000, 0.15, -15]; },
                scale: [4000, 0.5, 5],
                iterations: 900,
                html: 'e<sup>-e<sup>-t</sup></sup>',
            },
            logistic: {
                variables: 3,
                formula: {
                    main: function (K, B, C, x) { return (K*Math.exp(B*(C-x))*B)/Math.pow((1+Math.exp(B*(C-x))),2); },
                    integral: function (K, B, C, x) { return K/(1+Math.exp(B*(-x+C))); },
                    centerPoint: function (K, B, C) { return C; },
                    startPoint: function (K, B, C) { return (C*B-Math.log(250*K*B))/(B); },
                    endPoint: function (K, B, C) { return (C*B+Math.log(250*K*B))/(B); },
                },
                seed:  function () { return [50000, 0.1, 80]; },
                scale: [16666, 0.3, 20],
                iterations: 900,
                html: '<div style="border-bottom:solid 1px;text-align:center">e<sup>t</sup></div>1+e<sup>t</sup>',
            },
            genlog: {
                variables: 3,
                formula: {
                    main: function (K, B, C, x) { const n = 0.0220233; return (B*Math.exp(-B*(-C+x))*Math.pow((1+Math.exp(-B*(-C+x))),(-1-(1)/(n)))*K)/(n); },
                    integral: function (K, B, C, x) { const n = 0.0220233; return (K)/Math.pow((1+Math.exp(-B*(x-C))),((1)/(n))); },
                    centerPoint: function (K, B, C) { const n = 0.0220233; return C-(Math.log(n))/(B); },
                    startPoint: function (K, B, C) { const n = 0.0220233; return (B*C-Math.log(Math.pow(25000,n)-1))/(B); },
                    endPoint: function (K, B, C) { const n = 0.0220233; return (B*C-Math.log(Math.pow(((K-1)/(K)),(-n))-1))/(B); },
                },
                n: { China: 0.3804, World:0.767209, Korea:0.414364,Hubei:0.125844 },
                seed:  function () { return [50000,0.01,-15]; },
                scale: [16666, 1, 5],
                iterations: 900,
                html: '<div style="border-bottom:solid 1px;text-align:center">1</div><sup>n</sup>&radic;<span style=text-decoration:overline>1+e<sup>-t</sup></span>',
            },
            genlog2: {
                variables: 3,
                formula: {
                    main: function (K, n, C, x) { var B=0.0596948+n*0.127016; return (B*Math.exp(-B*(-C+x))*Math.pow((1+Math.exp(-B*(-C+x))),(-1-(1)/(n)))*K)/(n); },
                    integral: function (K, n, C, x) { var B=0.0596948+n*0.127016;return (K)/Math.pow((1+Math.exp(-B*(x-C))),((1)/(n))); },
                    centerPoint: function (K, n, C) { var B=0.0596948+n*0.127016;return C-(Math.log(n))/(B); },
                    startPoint: function (K, n, C) { var B=0.0596948+n*0.127016;return (B*C-Math.log(Math.pow(25000,n)-1))/(B); },
                    endPoint: function (K, n, C) { var B=0.0596948+n*0.127016;return (B*C-Math.log(Math.pow(((K-1)/(K)),(-n))-1))/(B); },
                },
                seed:  function () { return [500000,0.00115,-15]; },
                scale: [150000, 0.004, 5],
                iterations: 900,
                html: '<span style=color:orange><div style="border-bottom:solid 1px;text-align:center">1</div><sup>n</sup>&radic;<span style=text-decoration:overline>1+e<sup>-t</sup></span></span>',
            },
        };

        var deleteModelFromCache = function (modelName) {
            for (var src in cache)
                for (var subj in cache[src])
                    for (var n in cache[src][subj])
                        delete cache[src][subj][n][modelName];
        }
        var trainFrom2 = function (subj) {
            $('.container').LoadingOverlay('show');
            setModel('sir');
            genetic.onFinished = function(sol) {
                genetic.onFinished = displayResults;
                $('.container').LoadingOverlay('hide');
                loadModel2({name:subj,A:sol.variables[0],B:sol.variables[1],C:sol.variables[2],D:sol.variables[3]});
            }
        }
        var trainFrom = function (subj) {
            genetic.onFinished = function(sol) {
                if (sol.points.peak >= sol.points.current) {
                    genetic.onFinished = displayResults;
                    return graph.refuse('Cannot train on data until peak was reached');
                }
                var vars = solution.variables;
                vars[0] = 0.0220233;
                var saved = { modelName: model, formula: genetic.formula, seed: genetic.seed, scale: genetic.scale  };
                model = Math.random().toString();
                var m = {
                    formula: {},
                    iterations: 300,
                    seed: new Function([],
                    'return ' + JSON.stringify(vars) + ';'), scale: vars.map(function (x) { return x / 3; }),
                };
                for (var k in genFormula)
                    m.formula[k] = new Function(['K','B','C','x'], genFormula[k].toString().split('{')[1].split('}')[0].replace('848076', 'K; K=' + solution.total));
                for (var k in m)
                    genetic[k] = m[k];
                models[model] = m;
                var end = Math.min(dates.length, Math.floor(solution.points.end));
                var minPossible = -1, sum = 0;
                while (sum < 3 && minPossible < end) {
                    sum += cases[clicked][++minPossible];
                }
                var start = Math.max(minPossible, Math.floor(solution.points.start));
                var start = minPossible;
                var then = function (sol) {
                    var vars = cache[currentSource][subj].map(function(x){ return x[model][noise].variables; });
                    var mean = graph.findDistributionMean(vars.map(function(x){ return x[0]; }));
                    window.training = vars.map(function (x) { return x.join('\t'); }).join('\n');
                    console.log('Generated n and B distribution saved to window.training');
                    delete models[model];
                    deleteModelFromCache(model);
                    model = saved.modelName;
                    delete saved.modelName;
                    for (var k in saved)
                        genetic[k] = saved[k];
                    genetic.onFinished = displayResults;
                    loadModel({ slant: mean, speed: 10 });
                }
                loopDates(currentSource, clicked, start, end, then, 500);
            }
            clicked = subj;
            estimate(subj);
        }

        var genFormula = {
            main: function (K, B, C, x) { var n = 848076; return (B*Math.exp(-B*(-C+x))*Math.pow((1+Math.exp(-B*(-C+x))),(-1-(1)/(n)))*K)/(n); },
            integral: function (K, B, C, x) { var n = 848076; return (K)/Math.pow((1+Math.exp(-B*(x-C))),((1)/(n))); },
            centerPoint: function (K, B, C) { var n = 848076; return C-(Math.log(n))/(B); },
            startPoint: function (K, B, C) { var n = 848076; return (B*C-Math.log(Math.pow(25000,n)-1))/(B); },
            endPoint: function (K, B, C) { var n = 848076; return (B*C-Math.log(Math.pow(((K-1)/(K)),(-n))-1))/(B); },
        };

        var loadModel = function (conf) {
            conf = conf || window.customConf || { slant: 4.03, speed: 10 };
            swal({
                title: 'Your model',
                text: 'Press "Load". The model will appear under Models menu as "Custom"',
                content: $('<textarea style=width:400px;height:99px onchange="swal.setActionValue($(this).val())">' + JSON.stringify(conf) + '</textarea>')[0],
                buttons: ['Cancel', 'Load'],
            }).then(function(json) {
                if (!json) return
                try {
                    json = JSON.parse(json);
                    for (var k in json)
                        conf[k] = json[k];
                    window.customConf = conf;
                    var seed = [100000,0.1,50];
                    var model = {
                        variables: 3,
                        seed:  new Function([], 'return ' + JSON.stringify(seed) + ';'),
                        scale: seed.map(function (x) { return x / 3; }),
                        iterations: Math.round(10000 / conf.speed),
                        html: 'Custom',
                        formula: {},
                    };
                    for (var k in genFormula)
                        model.formula[k] = new Function(['K','B','C','x'], genFormula[k].toString().split('{')[1].split('}')[0].replace('848076', conf.slant));
                    models.custom = model;
                    $('#custom').show();
                    deleteModelFromCache('custom');
                    setModel('custom');
                } catch(e) {
                    swal({ icon: 'error', title: e.message, text: 'Loading model failed' })
                }
            });
        }

        var loadModel2 = function (conf) {
            conf = conf || window.customConf || {"A":3.586,"B":0.241,"C":-1.405,"D":3.2495,"name":"Custom model"};
            var name = conf.name;
            swal({
                title: name + ' model',
                text: 'Press "Load". The model will appear under Models menu as "' + name + '". You may want to copy and save configuration data in order to be able to load this model at will.',
                content: $('<textarea style=width:400px;height:99px onchange="swal.setActionValue($(this).val())">' + JSON.stringify(conf) + '</textarea>')[0],
                buttons: ['Cancel', 'Load'],
            }).then(function(json) {
                if (!json) return
                try {
                    json = JSON.parse(json);
                    for (var k in json)
                        conf[k] = json[k];
                    window.customConf = conf;
                    var seed = [solution.variables[4], solution.variables[5], solution.variables[6]];
                    var model = {
                        variables: 3,
                        seed:  new Function([], 'return ' + JSON.stringify(seed) + ';'),
                        scale: seed.map(function (x) { return x / 3; }),
                        iterations: 500,
                        html: name,
                        formula: {},
                    };
                    for (var k in models.sirTrained.formula)
                        model.formula[k] = new Function(['K','L','M','x'], models.sirTrained.formula[k].toString().match(/function[^{]+\{([\s\S]*)\}$/)[1]
                            .replace('aval', conf.A)
                            .replace('bval', conf.B)
                            .replace('cval', conf.C)
                            .replace('dval', conf.D)
                            .replace(/mname/g, name));
                    models[name] = model;
                    $('#method a').filter(function () { return $(this).text() == clicked + ' '; }).remove();
                    $('<a style=color:red class="dropdown-item" href="#">' + name +' <i title="User model" class="fas fa-question-circle"></i></a>')
                        .insertBefore('#method .dropdown-divider')
                        .on('click', function () {
                            setModel(name);
                            $(this).closest(".dropdown-menu").prev().dropdown("toggle");
                            return false;
                        });
                    deleteModelFromCache(name);
                    setModel(name);
                } catch(e) {
                    swal({ icon: 'error', title: e.message, text: 'Loading model failed' })
                }
            });
        }

        var denoise = function(ls, strength) {
            function kalmanError(modelError) {
                var C = -0.8683, K = 10.23;
                return 1 / Math.pow((modelError - C), K);
                //return modelError;
            }
            function modelError(a, b, c) {
                var proportional = (c - b) / (c + b);
                var differential = (a-b)/(a+b)-(b-c)/(b+c);
                return Math.sqrt(Math.pow(proportional || 0, 2) + Math.pow(differential || 0, 2));
            }
            function filter(kf, K) {
                return function (i) {
                    kf.R = K * kalmanError(modelError(ls[i-2], ls[i-1], ls[i]));
                    return kf.filter(ls[i]);
                    //return ls[i];
                }
            }
            var a= filter(new KalmanFilter(), 1);
            var b= filter(new KalmanFilter(), 2);
            var c= new KalmanFilter({R:1.5 / strength});
            var d= new KalmanFilter({R:1.5 / strength * 1.3 });
            var i = ls.length-1;
            while (++i < ls.length)
                ls[i] = a(i);
            while (--i >= 0)
                ls[i] = b(i);
            while (++i < ls.length)
                ls[i] = c.filter(ls[i]);
            while (--i >= 0)
                ls[i] = d.filter(ls[i]);
        }

        var tryKalman = function(src, country, n1, n2) {
            var a= new KalmanFilter({R:n1});
            var b= new KalmanFilter({R:n2});
            var orig = cases[country];
            cases[country] = orig.map(function (x) { return a.filter(x); })
                .reverse().map(function (x) { return a.filter(x); }).reverse();
            genetic.onFinished = function () {
                    analyse(function() {
                        genetic.onFinished = function () {
                            var results = {total:0, nextWeek:7, nextMonth:30};
                            for (k in results) {
                                var truth = graph.accumulated(graph.vertices, results[k]);
                                var errv = Math.sqrt(cache[src][country].map(function (x,i) { 
                                    return truth[i] ? Math.pow(x.genlog[k] - truth[i], 2) : 0;
                                }).reduce(function (a,b) {
                                    return a+b;
                                }, 0));
                                console.log([n1, n2, country, k, errv]);
                            }
                        };
                        cases[country] = orig;
                        delete cache[src][country][NaN];
                        estimate(country);
                    });
            };
            setModel('genlog');
        };


        genetic.formula = models.gompertz.formula;
        genetic.seed = models.gompertz.seed;
        genetic.scale = models.gompertz.scale;

        genetic.optimize = Genetic.Optimize.Minimize;
        genetic.select1 = Genetic.Select1.Tournament2;
        genetic.select2 = Genetic.Select2.FittestRandom;

        genetic.clone = function (obj) {
            return obj && typeof(obj) == 'object' ? [].concat(obj) : obj;
        }

        genetic.mutate = function (entity) {

            // allow chromosomal drift with this range (-0.05, 0.05)

            var i = Math.floor(Math.random() * entity.length);
            var drift = ((Math.random() - 0.5) * 2) * genetic.scale[i];
            entity[i] += drift;

            return entity;
        };

        // crossover via interpolation
        genetic.lerp = function (a, b, p) {
            return a + (b - a) * p;
        }

        genetic.crossover = function (mother, father) {
            var len = mother.length;
            var i = Math.floor(Math.random() * len);
            var r = Math.random();
            var son = [].concat(father);
            var daughter = [].concat(mother);

            son[i] = genetic.lerp(father[i], mother[i], r);
            daughter[i] = genetic.lerp(mother[i], father[i], r);

            return [son, daughter];
        };

        genetic.bind = function (fn, coefficients) {
            return fn.bind.apply(fn, [null].concat(coefficients));
        }

        genetic.fitness = function (entity) {

            var sumSqErr = 0;
            var vertices = this.userData["vertices"];
            var fn = this.bind(genetic.formula.main, entity) 

            var i;
            for (i = 0; i < vertices.length; ++i) {
                var err = fn(vertices[i][0]) - vertices[i][1];
                sumSqErr += err * err;
            }

            return Math.sqrt(sumSqErr);
        };

        genetic.generation = function (pop, generation, stats) {
        };

        genetic.notification = function (pop, generation, stats, isFinished) {

            var completion = Math.round((generation + 1) / models[model].iterations * 100) + '%';
            $('.progress-bar').css({ width: completion }).html(completion);

            if (isFinished) {
                var res = pop[0].entity;
                if (!res)
                    return graph.refuse("No solution found");
                window.solution = {
                    variables: res,
                    points: {
                        start: genetic.formula.startPoint.apply(null, res),
                        lastKnown: graph.vertices.length - 1,
                        current: currentPoint,
                        peak: genetic.formula.centerPoint.apply(null, res),
                        end: genetic.formula.endPoint.apply(null, res)
                    },
                }
                var zero = moment(dates[0]);
                solution.dates = {
                    start: zero.clone().add(solution.points.start, 'days'),
                    peak: zero.clone().add(solution.points.peak, 'days'),
                    end: zero.clone().add(solution.points.end, 'days')
                };
                var calc = function(formula, x) { return genetic.bind(formula, res)(x); };
                solution.correlation = (calc(genetic.formula.integral, solution.points.lastKnown) - calc(genetic.formula.integral, 0)) / known;
                solution.max = calc(genetic.formula.main, solution.points.peak);
                solution.total =  calc(genetic.formula.integral, solution.points.end);
                var now = calc(genetic.formula.integral, solution.points.current);
                solution.today = calc(genetic.formula.main, solution.points.current);
                solution.nextWeek = calc(genetic.formula.integral, solution.points.current + 7) - now;
                solution.nextMonth = calc(genetic.formula.integral, solution.points.current + 30) - now;
                var yester = graph.vertices[currentPoint-1];
                solution.increase = { 
                    today: yester && yester[1] ? ((solution.today - yester[1]) / yester[1]) : 0
                };
                var observationLength = Math.min(solution.points.lastKnown, solution.points.end) - Math.max(0, solution.points.start);
                var totalLength = solution.points.end - Math.max(0, solution.points.start);
                var areaX = (calc(genetic.formula.integral, solution.points.lastKnown) - calc(genetic.formula.integral, 0));
                var areaErr = (areaX - known) / (areaX + known) * 3;
                var prevX = calc(genetic.formula.main, solution.points.lastKnown - 1);
                var prevR = graph.vertices[solution.points.lastKnown-1][1];
                var lastX = calc(genetic.formula.main, solution.points.lastKnown);
                var lastR = graph.vertices[solution.points.lastKnown][1];
                var diffErr = ((lastX - prevX) - (lastR - prevR)) / solution.max / 1.5;
                var lastErr = (lastX - lastR) / (solution.max / 10 + lastX + lastR) * 2;
                var uncertainty = Math.pow((totalLength-observationLength)/(totalLength+observationLength), 2) / 2;
                solution.error = { proportional: lastErr, integral: areaErr, diff: diffErr, uncertainty: uncertainty,
                    model: Math.sqrt(Math.pow(areaErr, 2) + Math.pow(lastErr, 2) + Math.pow(diffErr, 2)),
                };
                solution.error.sigma = 0.1 + solution.error.model * Math.pow(solution.error.uncertainty, 3) * 350;
                var k = model == 'gompertz' ? 2 : 2;
                solution.error.range = 1 + solution.error.sigma * k;
                if (!cache[currentSource][clicked][timeBackClip])
                    cache[currentSource][clicked][timeBackClip] = {};
                if (!cache[currentSource][clicked][timeBackClip][model])
                    cache[currentSource][clicked][timeBackClip][model] = {};
                cache[currentSource][clicked][timeBackClip][model][noise] = solution;
                window.estimationInProgress = 0;
                genetic.onFinished(solution);
            }
        };

        // combine two probability distributions.
        // sigma must be sigma squared!
        var combineGaussians = function (sigma, mu, sigma1, mu1) {
            var k = sigma/(sigma+sigma1);
            sigma = sigma - k * sigma;
            mu = mu + k * (mu1 - mu);
            return {sigma:sigma,mu:mu};
        }
        var myKalman = function(ar) {
            var k, sigma, mu;
            return ar.map(function (solution) {
                var mu1 = solutionValue(solution, length);
                var sigma1 = Math.pow(solution.error.sigma * mu1, 2);
                if (!isFinite(mu1))
                    return [mu1,NaN];
                else if (mu == undefined) {
                    mu = mu1;
                    sigma = sigma1;
                } else {
                    var res = combineGaussians(sigma,mu,sigma1, mu1);
                    sigma = res.sigma;
                    mu = res.mu;
                }
                return [mu, Math.sqrt(sigma)];
            });
        }

        var displayResults = function (solution) {
            var length = solution.points.end - solution.points.start;
            $('#length-title').text((solution.dates.end.isBefore(moment()) ? 'Observed' : 'Expected') + ' Length');
            $('#length').html(numeral(length).format('0') + ' days');
            $('#sign').text(solution.increase.today > 0 ? '+' : '');
            $('#start').html(solution.dates.start.fromNow() + ' <span class=sm>' + solution.dates.start.format('DD MMM') + '</span>');
            $('#end-title').text((solution.dates.end.isBefore(moment()) ? 'Observed' : 'Expected') + ' End');
            $('#days').html(solution.dates.end.fromNow() + ' <span class=sm>' + solution.dates.end.format('DD MMM') + '</span>');
            $('#peak-title').text((solution.dates.peak.isBefore(moment()) ? 'Observed' : 'Expected') + ' Peak');
            $('#peak').html(solution.dates.peak.fromNow() + ' <span class=sm>' + solution.dates.peak.format('DD MMM') + '</span>');
            $('#fr-today').number(solution.today / solution.error.range);
            $('#to-today').number(solution.today * solution.error.range);
            $('#today-increase').number(solution.increase.today * 100);
            $('#fr-next-week').number(Math.max(0, solution.nextWeek / solution.error.range));
            $('#to-next-week').number(Math.max(0, solution.nextWeek * solution.error.range));
            $('#increase-next-week').number((solution.nextWeek) / known);
            $('#fr-next-month').number(solution.nextMonth / solution.error.range);
            $('#to-next-month').number(solution.nextMonth * solution.error.range);
            $('#increase-next-month').number(solution.nextMonth / known);
            $('#fr-total').number(Math.max(known + solution.nextMonth / solution.error.range, solution.total / solution.error.range));
            $('#to-total').number(Math.max(known + solution.nextMonth * solution.error.range, solution.total * solution.error.range));
            $('#increase').number(solution.total / known);
            if (!solution.total || solution.total < 0 || solution.correlation < 0.3 || solution.correlation > 3 || length < 15)
                return graph.refuse('Regression did not converge');
            $('#correlation').number(solution.correlation);
            $('#model-error').number(solution.error.model, '0.0');
            $('#model-error-rank').html(solution.error.model > 1 ? '<span class="badge badge-danger">HIGH <i title="Model does not fit to data well" class="fas fa-question-circle text-white"></i></span>' : solution.error.model > 0.2 ? '<span class="badge badge-secondary">AVG <i title="Model does not fit to data perfectly" class="fas fa-question-circle text-white"></i></span>' :'<span class="badge badge-success">LOW <i title="Model fits to data very well" class="fas fa-question-circle text-white"></i></span>');
            $('#sigma').number(solution.error.sigma, '0.0');
            $('#sigma-rank').html(solution.error.sigma <= 0.2 ? '<span class="badge badge-success">LOW <i title="Prediction has high confidence" class="fas fa-question-circle text-white"></i></span>' : solution.error.sigma < 2.5 ? '<span class="badge badge-success">AVG <i title="Prediction is inconclusive due to lack of observation" class="fas fa-question-circle text-white"></i></span>' : '<span class="badge badge-danger">HIGH <i title="Prediction is highly speculative" class="fas fa-question-circle text-white"></i></span>');
            $('#figures').show();
            var lineWidth = 2, strokeStyle = yellow;
            graph.drawFunction(solution.variables, strokeStyle, lineWidth, genetic.formula.main);
            $('.fa-question-circle').tooltip();
            $('#sample')[known > 150 ? 'show' : 'hide']();
            onResize();
        };
        genetic.onFinished = displayResults;


        function Graph(canvas, xmax, ymax) {
            this.canvas = document.getElementById("scratch");

            this.xmax = xmax;
            this.ymax = ymax;

            // canvas dimensions
            this.width = parseInt(canvas.style.width);
            this.height = parseInt(canvas.style.height);

            this.legend = $('<div id=legend style="display:none;position:absolute;z-index:2;top:0;text-align:left;width:' + this.width + ';height:' + this.height + '">').insertAfter(this.canvas);

            // retina
            var dpr = window.devicePixelRatio || 1;
            canvas.width = this.width * dpr;
            canvas.height = this.height * dpr;
            this.ctx = canvas.getContext("2d");
            this.ctx.scale(dpr, dpr);


            this.bound = [0, this.width - 1, this.height - 1, 0];

            this.bound[0] += 25;
            this.bound[1] -= 25;
            this.bound[2] -= 25;
            this.bound[3] += 50;

            this.vertices = [];
        }

        Graph.prototype.drawLine = function (color, width, point) {
                graph.drawFunction([0,0,0], color, width, function(a,b,c,x) { 
                    if (x < point - graph.inc || x > point + graph.inc) return NaN;
                    else return graph.ymax * (x < point); });
        }

        Graph.prototype.drawArray = function (a, color) {
            graph.vertices = a.map(function (x, i) { return [i, x]; });
            graph.drawVertices(color || '#000');
        }

        Graph.prototype.denoiseVertices = function (strength) {
            var ls = graph.vertices.map(function (x) { return x[1]; });
            denoise(ls, strength);
            graph.loadVertices(ls);
        }

        Graph.prototype.addLegend = function (title, data, alignLeft, width) {
            var align = alignLeft ? 'left' : 'right';
            this.legend.html('<table style="position:absolute;' + align + ':0;bottom:0;margin:' + this.bound[0] + 'px 25px 70px ' + (this.bound[3] + 25) + 'px"><caption style=caption-side:top;text-align:' + align + '>' + title + '</caption><tr>' + data.map(function(d) {
                var width = d[3] || 1;
                var ln = '<div style="display:inline-block;border:solid ' + width + 'px ' + d[0] + ';width:50px;height:0"></div>';
                var txt = '<i title="' + d[2] + '" class="fas fa-question-circle text-secondary"></i>';
                return '<td>' + (alignLeft ? [ln, d[1], txt] : [txt, d[1], ln]).join('</td><td>') + '</td>';
            }).join('</tr><tr>') + '</tr></table>').show();
            $('#legend i').tooltip();
        }


        Graph.prototype.drawFunction = function (coefficients, strokeStyle, lineWidth, fn) {
            var ctx = this.ctx;
            ctx.save();
            var bound = this.bound;

            //ctx.setLineDash([1, 1]);
            ctx.strokeStyle = strokeStyle;
            var xmax = this.xmax;
            var ymax = this.ymax;
            var xstride = (bound[1] - bound[3]) / xmax;
            var ystride = (bound[2] - bound[0]) / ymax;
            graph.inc = 1 / xstride;

            ctx.lineWidth = lineWidth;

            ctx.beginPath();
            var x;
            var old;
            for (x = 0; x < xmax; x += graph.inc) {
                var cx = x * xstride + bound[3];
                var cy = bound[2] - genetic.bind(fn, coefficients)(x) * ystride;

                if (x == 0) {
                    ctx.moveTo(cx, cy);
                    old = cy;
                } else if (isFinite(cy)) {
                    ctx.lineTo(cx, cy);
                    old = cy;
                } else {
                    ctx.moveTo(cx, old);
                }
            }

            ctx.stroke();

            ctx.restore();
        }

        Graph.prototype.draw = function (logScale) {
            this.legend.html('');
            this.drawBars();
            this.drawAxis(logScale);
        };

        Graph.prototype.drawBars = function () {
            this.ctx.clearRect(0, 0, this.width, this.height);
            var ctx = this.ctx;
            ctx.save();
            var bound = this.bound;
            ctx.strokeStyle = "#000";
            ctx.fillStyle = "#000";
            var xmax = this.xmax;
            var ymax = this.ymax;
            var xstride = (bound[1] - bound[3]) / xmax;
            var ystride = (bound[2] - bound[0]) / ymax;


            var i;

            // x-grid
            for (i = 0; i <= xmax; i += Math.max(Math.floor(xmax / 15), 1)) {
                var cx = i * xstride + bound[3];
                var y = bound[2];

                ctx.strokeStyle = "#eee";
                ctx.beginPath();
                ctx.moveTo(cx, bound[0]);
                ctx.lineTo(cx, y);
                ctx.stroke();
            }

            // y-grid
            for (i = 0; i <= ymax; i += Math.max(Math.floor(ymax / 10), 1)) {
                var cx = bound[3];
                var y = bound[2] - i * ystride;
                ctx.beginPath();
                ctx.moveTo(cx, y);
                ctx.lineTo(bound[1], y);
                ctx.stroke();
            }


            // x/y bars
            ctx.beginPath();
            ctx.strokeStyle = "#bbb";
            ctx.moveTo(bound[3], bound[0]);
            ctx.lineTo(bound[3], bound[2]);
            ctx.lineTo(bound[1], bound[2]);
            ctx.lineWidth = 3;
            ctx.stroke();


            ctx.lineWidth = 1;
            var i;

            ctx.restore();
        }

        Graph.prototype.drawAxis = function(logScale, yDates) {
            var ctx = this.ctx;
            ctx.save();
            var bound = this.bound;
            ctx.strokeStyle = "#000";
            ctx.fillStyle = "#000";
            var xmax = this.xmax;
            var ymax = this.ymax;
            var xstride = (bound[1] - bound[3]) / xmax;
            var ystride = (bound[2] - bound[0]) / ymax;

            graph.ctx.clearRect(0,0,bound[3]-1,bound[2]);
            graph.ctx.clearRect(0,graph.bound[2]+1,graph.width,graph.height);

            // x bars
            ctx.strokeStyle = "#000";
            for (i = 0; i <= xmax - 1; i += Math.max(Math.floor(xmax / 8), 2)) {
                var cx = i * xstride + bound[3];
                var y = bound[2];

                ctx.beginPath();
                ctx.moveTo(cx, y + 1);
                ctx.lineTo(cx, y + 5);
                ctx.stroke();

                ctx.font = "12px sans-serif";
                ctx.textAlign = "center";
                ctx.fillText(i+1, cx, y - 5);
                ctx.fillText(dates[i], cx, y + 16);
            }
            // y bars
            for (i = 0; i <= ymax; i += Math.max(Math.floor(ymax / 10), 1)) {
                var cx = bound[3];
                var y = bound[2] - i * ystride;
                ctx.beginPath();
                ctx.moveTo(cx, y);
                ctx.lineTo(cx - 4, y);
                ctx.stroke();

                ctx.font = "12px sans-serif";
                ctx.textAlign = "right";
                var val = logScale? Math.exp(i) : i;
                ctx.fillText(numeral(val).format('0a'), cx - 8, y + 4);
            }
            ctx.restore();
        }

        Graph.prototype.drawText = function (msg) {
            var ctx = this.ctx;
            var b = this.bound;
            ctx.font = "30px sans-serif";
            ctx.textAlign = "center";
            ctx.fillStyle = "#ccc";
            ctx.fillText(msg, (b[3] + b[1]) / 2, (b[2] + b[0]) / 2);
        }


        Graph.prototype.drawArea = function (fill, array) {
            var ctx = this.ctx;
            ctx.save();
            var bound = this.bound;
            var xmax = this.xmax;
            var ymax = this.ymax;
            var xstride = (bound[1] - bound[3]) / xmax;
            var ystride = (bound[2] - bound[0]) / ymax;
            var i;
            ctx.fillStyle = fill || "#0080ff77";
            ctx.lineWidth = 2;
            // vertices
            ctx.beginPath();
            var cxx, cyy, x0;
            array.map(function(p, i) {
                var cx = (p[0] + (i >= array.length / 2) - 0.5) * xstride + bound[3];
                var cy = bound[2] - p[1] * ystride;
                if (!x0) {
                    ctx.moveTo(cx,cy);
                    x0 = cx;
                } else  {
                    ctx.lineTo(cx, cyy);
                    ctx.lineTo(cx, cy);
                    //ctx.quadraticCurveTo(cxx, cyy, (cx + cxx) / 2, (cy + cyy) / 2);
                }
                cxx = cx;
                cyy = cy;
            });
            ctx.lineTo(x0, cyy);
            ctx.closePath();
            ctx.fill();
            ctx.restore();
        };

        Graph.prototype.drawVertices = function (fill, stroke) {

            var ctx = this.ctx;
            ctx.save();
            var bound = this.bound;

            var xmax = this.xmax;
            var ymax = this.ymax;
            var xstride = (bound[1] - bound[3]) / xmax;
            var ystride = (bound[2] - bound[0]) / ymax;

            var i;

            ctx.fillStyle = fill || "#000";
            ctx.strokeStyle = stroke || "#fff";
            ctx.lineWidth = 2;

            // vertices
            for (i = 0; i < this.vertices.length; ++i) {
                var cx = this.vertices[i][0] * xstride + bound[3];
                var cy = bound[2] - this.vertices[i][1] * ystride;

                ctx.beginPath();
                ctx.arc(cx, cy, 3, 0, 2 * Math.PI);
                ctx.fill();
                ctx.stroke();
            }

            ctx.restore();
        };

    </script>
    <script type=text/javascript>
        var gray = '#bbb', blue = '#00f', red = '#f00', green = '#28a745', violet = '#572f8355', yellow = '#ffc107', paleYellow = '#ffc10755', rose = '#ff000033', black = '#000';
        window.cache = {};
        $.expr[":"].contains = $.expr.createPseudo(function (arg) {
            return function (elem) {
                return $(elem).text().toUpperCase().indexOf(arg.toUpperCase()) >= 0;
            };
        });
        $.expr[":"].equals = $.expr.createPseudo(function (arg) {
            return function (elem) {
                return $(elem).text().toUpperCase() == arg.toUpperCase();
            };
        });
        $.fn.number = function (n, fmt) {
            fmt = fmt || '0,0 a';
            if (this.length)
                this.html(numeral(n).format(fmt));
        }
        var translate = { US: 'United States of America', 'Korea, South': 'South Korea', 'Republic of Korea': 'South Korea', 'Bahamas, The': 'Bahamas', 'Gambia, The': 'Gambia', 'Congo (Brazzaville)': 'Congo', 'Congo (Kinshasa)': 'Democratic Republic of Congo', 'Confirmed, China': 'China', 'Confirmed, Globally': 'World', 'Confirmed, Outside of China': 'Outside of China', 'Hubei , China': 'Hubei, China', 'Russia': 'Russian Federation' };
        search = function (ev) {
            var str = $(ev.target).val();
            if (str.length < 2) $('#menu a').show();
            $('#menu a').hide();
            $('#menu a:contains(' + str + ')').show();
        }
        var processCsvWHO = function (csv) {
            window.data = csv.split('\n').map(function (s) { return s.replace(/"([^,]+), ([^,]+)"/g, '$2 $1').split(','); });
            var titles = data.shift();
            window.cases = {};
            window.dates = titles.splice(3).map(function(s) { return moment(s, 'M/D/YYYY').format('YYYY-MM-DD'); });
            data.map(function (ls, i) {
                var last = 0;
                var title = (ls[0] ? (ls[0] + ', ') : '') + ls[1];
                if (ls[0] != 'Deaths')
                    cases[translate[title] || title] = ls.splice(3).map(function(x) { x = Math.max(parseInt(x) || last, last); var n = x - last; last = x; return n;});
            });
            window.data = csv.split('\n').map(function (s) { return s.replace(/"([^,]+), ([^,]+)"/g, '$2 $1').split(','); });
        };
        var processCsvNYT = function (csv, county) {
            window.dates = [],
            window.cases = { };
            if (!county)
                cases['USA Total'] = [];
            window.data = { };
            var idx = county ? 4 : 3;
            var date, title, last = {};
            csv.split('\n').map(function (s) {
                var ls = s.split(',');
                var k = ls[1];
                if (county)
                    k += (', ' + ls[2]);
                if (date != ls[0]) {
                    title = undefined;
                    date = ls[0];
                    dates.push(date);
                    if (!data[date])
                        data[date] = {};
                }
                if (title != k) {
                    title = k;
                    cases[title] = [];
                    last[title] = 0;
                    data[date][title];
                }
                data[date][title] = ls[idx];
            });
            dates.shift(); // remove title;
            if (!county)
                cases['USA Total'] = dates.map(function(x) { return 0 });
            delete cases.undefined;
            delete cases['county, state'];
            delete cases['state'];
            for (var k in cases) if (k != 'USA Total') {
                for (var i = 0; i < dates.length; ++i) {
                    var n = (data[dates[i]][k] || 0);
                    var nn = n - last[k];
                    cases[k].push(nn);
                    if (!county)
                        cases['USA Total'][i] += nn;
                    last[k] = n;
                }
            }
        };
        var processCsvJHU = function (csv) {
            window.data = csv.split('\n').map(function (s) { return s.replace(/"([^,]+), ([^,]+)"/g, '$2 $1').split(','); });
            var titles = data.shift();
            window.cases = { World:[], China:[], Canada: [] };
            window.dates = titles.splice(4).map(function(s) { return moment(s, 'M/D/YYYY').format('YYYY-MM-DD'); });
            data.map(function (ls, i) {
                var last = 0;
                var title = (ls[0] ? (ls[0] + ', ') : '') + ls[1];
                cases[translate[title] || title] = ls.splice(4).map(function(x, i) {
                    x = Math.max(parseInt(x) || last, last);
                    var n = x - last;
                    last = x;
                    cases.World[i] = (cases.World[i]||0) + n;
                    if (ls[1] == 'China')
                        cases.China[i] = (cases.China[i]||0) + n;
                    else if (ls[1] == 'Canada')
                        cases.Canada[i] = (cases.Canada[i]||0) + n;
                    return n;
                });
            });
            delete cases.undefined;
            delete cases['Recovered, Canada'];
            delete cases['Diamond Princess, Canada'];
            window.data = csv.split('\n').map(function (s) { return s.replace(/"([^,]+), ([^,]+)"/g, '$2 $1').split(','); });
        };
        var processCsv = function (csv) {
            window.data = csv.split('\n').map(function (s) { return s.split(','); });
            var titles = data.shift();
            window.cases = {};
            dates = [];
            titles.map(function (s) {
                cases[s] = [];
            })
            delete cases.date;
            data.map(function (ls, i) {
                ls.map(function (el, j) {
                    var title = titles[j];
                    if (title == 'date') dates.push(el);
                    else cases[title].push(el ? parseInt(el) : 0);
                });
            });
            while (!dates[dates.length - 1])
                dates.pop();
        };
        var processJson = function (res) {
            window.cases = { World: [] };
            dates = [];
            var start = true;
            Object.keys(res).sort().forEach(function(k) {
                var k2 = translate[k] || k;
                cases[k2] = [];
                var last = 0;
                for (var i = 0; i < res[k].length; ++i) {
                    var c = res[k][i];
                    var now = c.confirmed;
                    var diff = now - last;
                    cases[k2].push(diff);
                    if (start) {
                        cases.World.push(0);
                        dates.push(moment(res[k][i].date).format('YYYY-MM-DD'));
                    }
                    cases.World[i] += diff;
                    last = now;
                }
                start = false;
            });
        }

        var adjust = function (k, d) {
            var k2 = k + ' Adjusted';
            // approximate realistic figure for day d
            var approx = (cases[k][d - 1] + cases[k][d + 1]) / 2;
            // total cases before day d
            var x = 0.0; for (i = 0; i < d; ++i) x += cases[k][i];
            // add day d
            x += approx;
            var surplus = cases[k][d] - approx;
            var K = 1 + surplus / x;
            // distribute surplus proportionally between prior days
            cases[k2] = [];
            for (i = 0; i < d; ++i) cases[k2].push(cases[k][i] * K);
            // same for day d
            cases[k2].push(approx * K);
            // copy the rest
            for (i = d + 1; i < cases[k].length; ++i) cases[k2].push(cases[k][i]);
            cases[k] = cases[k2];
            delete cases[k2];
        }
        var spread = function (k, d) {
            // take next value and previous non-zero, and draw a line between them
            var nonZero = d;
            while (--nonZero > 0)
                if (cases[k][nonZero])
                    break;
            var n = (d - nonZero);
            var a = cases[k][nonZero];
            // (2 y - 2 a n)/(n^2 + n)
            var b = (2 * cases[k][d] - 2 * a * n) / (Math.pow(n,2) + n);
            while (++nonZero <= d)
                cases[k][nonZero] = (a += b);
        }
        graph.candy = function () {
            graph.vertices = [[graph.xmax * Math.random(),graph.ymax * Math.random()]];
            graph.drawVertices('rgb(' + [1,2,3].map(function(){return Math.random() * 255;}) +')'); 
        }
        graph.refuse = function (msg) {
            var p;
            if ((p = cache[currentSource][clicked]) && (p = p[timeBackClip]) && (p = p[model]))
                delete p[noise];
            $('#sum').parent().show();
            $('#figures').show();
            $('.result').hide();
            graph.draw();
            graph.drawVertices();
            graph.drawText(msg);
            if (genetic.onFinished != displayResults)
                genetic.onFinished();
            window.estimationInProgress = 0;
        }
        var median = function(ar){
            for (var i = 0; i < ar.length; ++i){
                var cur = ar[i];
                var prev = ar[i-1] || cur;
                var next = ar[i+1] || cur;
                var t = typeof(cur);
                ar[i] = t == 'object'
                    ? [cur[0], (prev[1] + next[1]) / 2]
                    : t == 'number' ? (prev + next) / 2 : cur;
            }
        }
        graph.loadVertices = function(ls) {
            graph.vertices = [];
            ls.map(function (c, i) { graph.vertices.push([i, c]); });
        }

        var getFormerSolution = function(n) {
            var models = cache[currentSource][clicked][n];
            return models && models[model] //|| models['gompertz'] || models['genlog'];
        }
        var adjustLastValue = function() {
            var n = graph.vertices.length - 1;
            var orig = graph.vertices[n];
            if (orig) orig = orig[1];
            var prev = getFormerSolution(n);
            if (prev) {
                var tmp = graph.vertices;
                graph.vertices = [n, orig];
                graph.drawVertices('#ccc');
                graph.vertices = tmp;
                //res = combineGaussians(1 + Math.pow(prev.error.sigma,2), prev.today, Math.pow((prev.today - orig)/(prev.today + orig), 2), orig);
                //graph.vertices[n] = [n, res.mu];
                if (orig == 0 || prev.error.sigma < 2.5 && prev.today > orig) {
                    var guess = prev.today;
                    graph.vertices[n] = [n, guess];
                    //cases[clicked][n] = guess;
                }
            }
        }
            
        var estimate = function (country) {
            window.estimationInProgress = 1;
            window.clicked = country;
            if (!cache[currentSource][clicked])
                cache[currentSource][clicked] = [];
            $('#country').html(country);
            $('.progress').show();
            $('#figures').hide();
            $('.result').show();
            graph.loadVertices(cases[country]);
            if (denoiseLevel[noise])
                graph.denoiseVertices(denoiseLevel[noise])
            if (window.timeBackClip)
                graph.vertices.length = window.timeBackClip;
            //adjustLastValue();
            window.known = graph.vertices.reduce(function (a, b) { return a + b[1]; }, 0);
            window.currentPoint = window.timeBackClip || moment().diff(moment(dates[0]), 'days')
            $('#confirmed-total').number(known);
            if (graph.vertices[currentPoint - 1]) {
                $('#confirmed-yesterday').number(graph.vertices[currentPoint - 1][1]);
                $('#date-yesterday').html('(' + moment(dates[currentPoint - 1]).format('DD MMM') + ')');
            } else
                $('#confirmed-yesterday').html('<span class="badge badge-danger">NONE <i title="Not present in the data source" class="fas fa-question-circle text-white"></i></span>');
                $('#date-yesterday').html('(' + moment().add(-1,'days').format('DD MMM') + ')');
            var dataPoints = graph.vertices.reduce(function (a, b) { return a + (b[1] > 0); }, 0);
            $('#sum').number(known);
            if (known < 10 || dataPoints < 3)
                return graph.refuse('Insufficient number of confirmed cases');
            var ymax = graph.vertices.reduce(function (a, b) { return Math.max(a, b[1]); }, 0) * 2
            var scale = Math.floor(Math.log(ymax) / Math.log(10));
            var factor = Math.pow(10, scale);
            ymax = Math.round(ymax / factor) * factor;
            graph.xmax = graph.vertices.length;
            graph.ymax = Math.max(10, ymax);
            window.yscale = graph.ymax;
            graph.draw();
            graph.drawText(country);
            //graph.drawVertices('#abc');
            //median(graph.vertices);
            //median(graph.vertices);
            graph.drawVertices('#000');
            if (cache[currentSource][clicked][timeBackClip]
            && cache[currentSource][clicked][timeBackClip][model]
            && cache[currentSource][clicked][timeBackClip][model][noise]) {
                window.estimationInProgress = 0;
                solution = cache[currentSource][clicked][timeBackClip][model][noise];
                genetic.onFinished(solution);
            }
            else {
                var config = { iterations: models[model].iterations, size: 250, crossover: 0.4, mutation: 1.0, skip: 10 };
                var userData = { terms: models[model].variables, vertices: graph.vertices };
                $('h1')[0].scrollIntoView();
                genetic.evolve(config, userData);
            }
        }
        var clickFn = function (el, k) {
            return function () {
                $('#sample').hide();
                genetic.onFinished = displayResults;
                el.parent().find('.active').removeClass('active');
                el.addClass('active');
                estimate(k);
            }
        }
        $('#search').on('keyup', search);
        var initiateUI = function() {
            $('#source .dropdown-toggle').text($('#source .' + currentSource).text());
            $('.container').LoadingOverlay('hide');
            $('.actual').text('(' + moment(dates[window.timeBackClip || (dates.length - 1)]).add(1,'days').fromNow() + ')');
            $('#menu').html('');
            for (k in cases) {
                var el = $('<a class="list-group-item list-group-item-action" href=#' + (window.timeBackClip || '') + ';' + currentSource + ';' + k.replace(/ /g, '+') + '>' + k + '</div>');
                el.on('click', clickFn(el, k));
                $('#menu').append(el);
            }
            if (window.clicked && $('#menu a:equals(' + clicked + ')').length)
                $($('#menu a:equals(' + clicked + ')')[0]).click();
            else
                $($('#menu a:first')[0]).click();
            if ($('#search').val())
                $('#search').keyup();
        }
        var sourceData = function(src) {
            window.cache[src] = {};
            window.currentSource = src;
            $('.container').LoadingOverlay('show');
            var error = function(){
                graph.draw();
                graph.refuse('Network error');
                var int = window.setInterval(graph.candy, 30);
                window.setTimeout(function () { window.clearInterval(int); }, 5000);
            }
            if (src == 'nyt')
                //$.get('https://raw.githubusercontent.com/nytimes/covid-19-data/master/us-counties.csv').then(function (csv) {
                $.get('https://raw.githubusercontent.com/nytimes/covid-19-data/master/us-states.csv').then(function (csv) {
                    processCsvNYT(csv);
                    setModel('genlog', 1);
                    initiateUI();
                }).fail(function () {
                    graph.refuse('Network error');
                    $('.container').LoadingOverlay('hide');
                    swal({ icon: 'error', content: $('<div>Error getting COVID-19 data from <i>raw.githubusercontent.com/nytimes</i></div>')[0], title: 'Network Error' })
                    .then(error);
                });
            else if (src == 'nytc')
                $.get('https://raw.githubusercontent.com/nytimes/covid-19-data/master/us-counties.csv').then(function (csv) {
                    processCsvNYT(csv, true);
                    setModel('gompertz',1);
                    initiateUI();
                }).fail(function () {
                    graph.refuse('Network error');
                    $('.container').LoadingOverlay('hide');
                    swal({ icon: 'error', content: $('<div>Error getting COVID-19 data from <i>raw.githubusercontent.com/nytimes</i></div>')[0], title: 'Network Error' })
                    .then(error);
                });
            else if (src == 'who')
                $.get('https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/who_covid_19_situation_reports/who_covid_19_sit_rep_time_series/who_covid_19_sit_rep_time_series.csv').then(function (csv) {
                    processCsvWHO(csv);
                    adjust('China', 27);
                    adjust('World', 27);
                    // delete cases['Hubei, China'];
                    // delete cases['Guangdong, China'];
                    // delete cases['Henan, China'];
                    // delete cases['Zhejiang, China'];
                    // delete cases['Hunan, China'];
                    // delete cases['Anhui, China'];
                    // delete cases['Jiangxi, China'];
                    // delete cases['Shandong, China'];
                    // delete cases['Jiangsu, China'];
                    // delete cases['Chongqing, China'];
                    // delete cases['Sichuan, China'];
                    // delete cases['Heilongjiang, China'];
                    // delete cases['Beijing, China'];
                    // delete cases['Shanghai, China'];
                    // delete cases['Hebei, China'];
                    // delete cases['Fujian, China'];
                    // delete cases['Guangxi, China'];
                    // delete cases['Shaanxi, China'];
                    // delete cases['Yunnan, China'];
                    // delete cases['Hainan, China'];
                    // delete cases['Guizhou, China'];
                    // delete cases['Tianjin, China'];
                    // delete cases['Shanxi, China'];
                    // delete cases['Liaoning, China'];
                    // delete cases['Hong Kong, China'];
                    // delete cases['Jilin, China'];
                    // delete cases['Gansu, China'];
                    // delete cases['Xinjiang, China'];
                    // delete cases['Inner Mongolia, China'];
                    // delete cases['Ningxia, China'];
                    // //delete cases['Taiwan, China'];
                    // delete cases['Qinghai, China'];
                    // //delete cases['Macau, China'];
                    // delete cases['Xizang, China'];
                    // delete cases["Unspecified*, China"];
                    setModel('genlog',1);
                    initiateUI();
                }).fail(function () {
                    $('.container').LoadingOverlay('hide');
                    swal({ icon: 'error', content: $('<div>Error getting COVID-19 data from <i>raw.githubusercontent.com/CSSEGISandData</i></div>')[0], title: 'Network Error' })
                    .then(error);
                });
            else if (src == 'jhu')
                $.get('https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/time_series_covid19_confirmed_global.csv').then(function (csv) {
                    processCsvJHU(csv);
                    adjust('China', 22);
                    adjust('China', 24);
                    adjust('Hubei, China', 22);
                    spread('Hubei, China', 22);
                    adjust('Hubei, China', 23);
                    adjust('World', 22);
                    adjust('World', 23);
                    adjust('France', 81);
                    setModel('genlog',1);
                    initiateUI();
                }).fail(function () {
                    graph.refuse('Network error');
                    $('.container').LoadingOverlay('hide');
                    swal({ icon: 'error', content: $('<div>Error getting COVID-19 data from <i>raw.githubusercontent.com/CSSEGISandData</i></div>')[0], title: 'Network Error' })
                    .then(error);
                });
            else if (src == 'oxford')
                $.get('https://cowid.netlify.com/data/new_cases.csv').then(function (csv) {
                    processCsv(csv);
                    //adjust('China', 27);
                    //adjust('World', 27);
                    setModel('gompertz',1);
                    initiateUI();
                }).fail(function () {
                    swal({ icon: 'error', content: $('<div>Error getting COVID-19 data from <i>ourworldindata.org</i></div>')[0], title: 'Network Error' });
                });
        }
        function setModel(m, norun) {
            $('#sample').hide();
            model = m;
            $('#method .dropdown-toggle').html(models[m].html).css((m == 'logistic' || m == 'genlog') ? {fontSize:'80%', padding:'0 1rem'}:{fontSize:'100%',padding:'0.5rem 1rem'});
            genetic.formula=models[m].formula;
            genetic.seed=models[m].seed;
            genetic.scale=models[m].scale;
            if (window.clicked && !norun)
                estimate(clicked);
        }
        function setNoise(level) {
            $('#sample').hide();
            var old = noise;
            noise = level;
            $('#noise .dropdown-toggle').html($('#noise .denoise-' + level + ' i:first')[0].outerHTML + ' ');
            if (window.clicked) {
                var vars = window.solution && solution.variables;
                estimate(clicked)
                if (vars && old) {
                    graph.addLegend('Noise reduction', [[gray, old, 'Regression with previous noise reduction'],[yellow, level, 'Regression with selected noise reduction']], solution.points.peak > graph.xmax / 2);
                    graph.drawFunction(vars, gray, 2, genetic.formula.main);
                }
            }
        }
        setNoise('slight');
        var onResize = function () {
            var foot = $('.footer').height() + 20;
            $('.auto-height').css('height', function () {
                var off = $(this).offset();
                if (off) {
                    var h = $(window).height() - off.top - foot;
                    return h + 'px';
                }
            });
        }
        onResize();
        $(window).resize(onResize);
        var onHashChange = function() {
            window.appConf = location.hash.substr(1).split(';');
            var oldClicked = window.clicked;
            window.clicked = appConf[2] && appConf[2].replace(/\+/g, ' ');
            var oldClip = window.timeBackClip;
            window.timeBackClip = parseInt(appConf[0]);
            if (appConf[3]){
                window.model = appConf[3];
                genetic.formula = genetic[model];
            }
            if (!window.currentSource || window.currentSource != appConf[1])
                sourceData(appConf[1] || 'jhu');
            // true only when manually change timebackclip
            else if (window.timeBackClip && oldClip != window.timeBackClip && window.clicked && window.clicked == oldClicked)
                estimate(window.clicked);
        }
        window.addEventListener('hashchange', onHashChange);
        onHashChange();
        graph.resize = function(x,y) {
            if (x) graph.xmax = Math.max.apply(null, graph.vertices.map(function(x){ return isFinite(x[0]) ? x[0] : -1/0; }));
            if (y) graph.ymax = Math.max.apply(null, graph.vertices.map(function(x){ return isFinite(x[1]) ? x[1] : -1/0; }));
        }
        graph.accumulated = function (ar, len) {
            var accum = 0;
            var res = ar.map(function(x) { return accum += x[1]; });
            if (!len) return res;
            return res.map(function (x, i) { return x - (res[i-len]||0); });

        }

        var solutionValue = function (s, length) {
            return length == 1 ? s.today : length == 7 ? s.nextWeek : length == 30 ? s.nextMonth : s.total;
        }

        var plotDuration = function() {
            graph.draw();
            graph.draw()
            graph.ymax = window.yscale;
            graph.loadVertices(cases[clicked]);
            //graph.drawVertices('#ccc');
            if (denoiseLevel[noise])
                graph.denoiseVertices(denoiseLevel[noise])
            graph.drawText(clicked);
            graph.drawVertices('#000');
            displayResults(solution);
            graph.vertices = [], graph.peak = [], graph.start = [], graph.end = [];
            cache[currentSource][clicked].map(function(models, i){
                var s = models[model] && models[model][noise];
                var dates = [s.points.start, s.points.peak, s.points.end];
                graph.peak[i-1] = dates[1];
                graph.start[i-1] = dates[0];
                graph.end[i-1] = dates[2];
                graph.vertices.push([i-1, dates[2]]);
            });
            graph.resize(false,true);
            graph.ymax = 365;
            graph.drawAxis(0);
            var ix = function(x,i) { return [i, x]; };
            var istart = function(x,i) { return [i, solution.points.start]; };
            graph.drawArea(paleYellow, graph.start.map(istart).concat(graph.end.map(ix).reverse()));
            graph.drawFunction([0,0,0], gray, 4, function(a,b,c,x) { return graph.end[Math.round(x)]? solution.points.current : NaN; });
            var legend = [
                    [paleYellow, 'Predicted duration', 'Estimated start to end range', 10],
                    ['#ff9800', 'Predicted peak', 'Moment when new cases peak'],
                ];
            legend.push([red, 'Observed start', 'Historic start, according to data analysis', 1]);
            //graph.drawLine(red, 1, solution.points.start);
            graph.drawFunction([0,0,0], red, 1, function(a,b,c,x) { return graph.start[Math.round(x)]? solution.points.start: NaN; });
            if (solution.points.peak < solution.points.current) {
                legend.push([black, 'Observed peak', 'Historic peak, according to data analysis', 1]);
                //graph.drawLine(black, 1, solution.points.peak);
                graph.drawFunction([0,0,0], black, 1, function(a,b,c,x) { return graph.end[Math.round(x)]? solution.points.peak: NaN; });
            }
            legend.push([gray, 'Current date', 'Current moment', 2]);
            graph.drawFunction([0,0,0], '#ff9800', 1, function(a,b,c,x) { return graph.peak[Math.round(x)]; });
            //graph.drawFunction([0,0,0], yellow, 2, function(a,b,c,x) { return graph.end[Math.round(x)]; });
            genetic.onFinished = displayResults;
            graph.addLegend('Forecast: ' + (length ? (length + '-day') : 'overall') + '<br>Method: ' + model
            + '<br>Noise reduction: ' + noise, legend, solution.points.peak > graph.xmax / 2);
        }
        
        var plotTolerance = function (src, subj, length) {
            graph.draw()
            graph.ymax = window.yscale;
            graph.loadVertices(cases[subj]);
            //graph.drawVertices('#ccc');
            if (denoiseLevel[noise])
                graph.denoiseVertices(denoiseLevel[noise])
            graph.drawText(subj);
            graph.drawVertices('#000');
            length = length || 0;
            displayResults(solution);
            var newCases = cases[clicked].map(function(x,i) { return [i, x]; });
            //graph.accum = graph.accumulated(newCases).map(function(x,i) { return Math.log(x + 1); });
            graph.accumN = graph.accumulated(newCases, length).map(function(x,i) { return Math.log(x + 1); });
            graph.vertices = [], graph.exact = [], graph.upper = [], graph.lower = [], graph.upper1 = [], graph.lower1 = [], graph.middle = [];
            cache[src][subj].map(function(models, i){
                var s = models[model] && models[model][noise];
                if (s && graph.accumN[i + length - 1]) {
                    var x = solutionValue(s, length), up1 = Math.log(x * s.error.range / 2 + 1), low1 = Math.log(x / s.error.range * 2 + 1),
                        up2 = Math.log(x * s.error.range + 1), low2 = Math.log(x / s.error.range + 1)
                    graph.vertices.push([i-1, up2]);
                    graph.vertices.push([i-1, low2]);
                    graph.upper[i-1] = up2;
                    graph.lower[i-1] = low2;
                    graph.upper1[i-1] = up1;
                    graph.lower1[i-1] = low1;
                    graph.middle[i-1] = (up2 + low2)/2;
                    graph.exact[i-1] = Math.log(x + 1);
                }
            });
            graph.resize(false,true);
            graph.ymax = Math.min(14, graph.ymax);
            graph.drawAxis(1);
            var ix = function(x,i) { return [i, x]; };
            //graph.drawArea('#ff000033', graph.upper1.map(ix).concat(graph.lower1.map(ix).reverse()));
            var legend = [
                    [paleYellow, 'Predicted range', 'Range between upper and lower predicted values', 10],
                ];
            if (length) {
                legend.push([gray, 'Ground truth', 'Data reported ' + length + ' days later', 2]);
                graph.drawFunction([0,0,0], gray, 4, function(a,b,c,x) { return smooth(graph.accumN, x + length); });
            } else {
                legend.push([gray, 'Current prediction', 'Latest prediction mean based on entirety of observation (till this day)', 2]);
                graph.drawFunction([0,0,0], gray, 4, function(a,b,c,x) { return Math.log(solutionValue(solution, length) + 1); });
            }
            graph.drawArea(paleYellow, graph.upper.map(ix).concat(graph.lower.map(ix).reverse()));
            graph.drawFunction([0,0,0], red, 2, function(a,b,c,x) { return graph.upper[Math.round(x)]; });
            graph.drawFunction([0,0,0], green, 2, function(a,b,c,x) { return graph.lower[Math.round(x)]; });
            graph.drawFunction([0,0,0], yellow, 1, function(a,b,c,x) { return graph.exact[Math.round(x)]; });
            genetic.onFinished = displayResults;
            graph.addLegend('Forecast: ' + (length ? (length + '-day') : 'overall') + '<br>Method: ' + model
            + '<br>Noise reduction: ' + noise, legend, solution.points.peak > graph.xmax / 2);
        }
        graph.compareModels = function(len) {
            var models = {logistic:red,genlog:blue,gompertz:'#03a9f4'};
            ls = {};
            for (var k in models) {
                var memory = cache[currentSource][clicked][NaN];
                var s = memory && memory[model];
                if (s) {
                    solution = s;
                    setModel(k);
                    plotTolerance(currentSource, clicked, len);
                    ls[k] = { hi: graph.upper, lo: graph.lower };
                }
            }
            if (!Object.keys(ls).length)
                return graph.refuse("No analysed models");
            graph.draw(1);
            graph.drawText(clicked);
            var legend = [];
            legend.push([gray, 'Ground truth', '']);
            if (len)
            graph.drawFunction([0,0,0], gray, 4, len ? function(a,b,c,x) { return smooth(graph.accumN, x + len); } :function(a,b,c,x) { return Math.log(solution.total + 1); });
            for (var k in ls) {
                legend.push([models[k], 'margins: ' + k, '']);
                for (var kk in ls[k]) {
                    var pp = ls[k][kk];
                    // var kf = new KalmanFilter({R:0.001,Q:16000});
                    // pp = pp.map(function(x) { return kf.filter(x); });
                    for (var i = 0; i < 3; ++i)
                        median(pp);
                    graph.drawFunction([0,0,0], models[k], 2, function(j,i,c,x) { return pp[Math.round(x)]; });
                }
            }
            graph.addLegend('Compare models<br>Forecast: ' + (len ? (len + '-day') : 'overall'), legend, solution.points.peak > graph.xmax / 2);
        }
        graph.findDistributionMean = function (ls) {
            graph.loadVertices(ls);
            graph.vertices=graph.vertices.map(function (x) { return [x[1],1]; });
            graph.resize(1,1);
            graph.draw();
            graph.drawVertices();
            var a=[], N = 300;
            for (var i = 0; i < N; ++i)
                a.push([graph.xmax/N*i, ls.reduce(function (a,b) {
                    return a+=models.logistic.formula.main(graph.ymax/10000,15/graph.xmax,graph.xmax/N*i,b);
                })]);
            graph.vertices=a;
            graph.resize(0,1);
            graph.drawVertices(black,gray);
            var best = graph.vertices.reduce(function (a,b) { return a[1] > b[1] ? a : b; },[0,0])
            graph.drawLine(red, 2, best[0]);
            return best[0];
        }
        graph.kalman = function(R, Q, fn) {
            var kf = new KalmanFilter({R:R,Q:Q});
            graph.filtered = cache[currentSource][clicked].map(function(models) { 
                var sol = models[model][noise];
                return fn(solutionValue(sol, length), sol.error.sigma, kf);
            });
            graph.upper = graph.filtered.map(function (x) { var m = x[0], rs = x[1] / m; r = 1 + rs * 2; return m * r; });
            graph.lower = graph.filtered.map(function (x) { var m = x[0], rs = x[1] / m; r = 1 + rs * 2; return m / r; });
            graph.middle = graph.filtered.map(function (x) { return x[0]; });
            graph.drawFunction([0,0,0], red, 2, function(a,b,c,x) { return graph.upper[Math.round(x)+1]; });
            //graph.drawFunction([0,0,0], violet, 1, function(a,b,c,x) { return smooth(graph.middle, x+1); });
            graph.drawFunction([0,0,0], green, 2, function(a,b,c,x) { return graph.lower[Math.round(x)+1]; });
        }
        function sinSmooth(ls, x) {
            var a = ls[Math.floor(x)], b = ls[Math.ceil(x)], c = x-Math.floor(x);
            return a + (1 - Math.cos(c * Math.PI)) / 2 * (b - a);
        }
        function smooth(ls, x) {
            var a = ls[Math.floor(x)], b = ls[Math.ceil(x)], c = x-Math.floor(x);
            return a + c * (b - a);
        }
        function loopDates(src, subj, fr, to, then, cycles) {
            var seed = models[model].seed;
            solution.variables = models[model].seed;
            var iters = models[model].iterations;
            $.LoadingOverlay('show', {progress: true, text:'Running earlier predictions...'});
            then = then || function () { plotTolerance(src, subj); }
            var start = moment();
            var speed0 = 0;
            var damper = new KalmanFilter({R:0.1});
            function iter(n) { 
                if (n >= (to || cases[subj].length)) {
                    genetic.onFinished = function(sol) {
                        window.solution = sol;
                        models[model].iterations = iters;
                        models[model].seed = seed;
                        $.LoadingOverlay('hide');
                        then();
                    }
                    timeBackClip = NaN;
                    estimate(subj);
                }
                else {
                    genetic.onFinished = function() {
                        models[model].seed = solution.variables;
                        models[model].iterations = cycles;
                        iter(n+1);
                    }
                    var done = (n - fr) / (to - fr);
                    $.LoadingOverlay('progress', done * 100);
                    var now = moment(), took = now - start, speed = took / done, todo = 1 - done, accel = speed - speed0,
                        avgSpeed = (speed + speed + accel * (to - n)) / 2, remains = avgSpeed * todo;
                    if (done > 0 && took > 100) {
                        var remains = moment.duration(damper.filter(remains));
                        $.LoadingOverlay('text', 'About ' + (remains.minutes() ? (remains.minutes() + ' Minutes ') : '') + remains.seconds() + ' Seconds ' + 'remaining')
                        speed0 = speed
                    }
                    timeBackClip = n+1;
                    estimate(subj);
                    //location.hash='#'+[n+1,src,subj.replace(/ /g, '+')].join(';');
                }
            }
            iter(fr || 4);
        }
        function analyse(then) {
            var end = Math.min(dates.length, Math.floor(solution.points.end));
            var minPossible = -1, sum = 0;
            while (sum < 3 && minPossible < end) {
                sum += cases[clicked][++minPossible];
            }
            //var start = Math.max(minPossible, Math.floor(solution.points.start));
            var start = minPossible;
            //end = start + 1;
            loopDates(currentSource, clicked, start, end, then, 150);
        }
        function sampleAll() {
            var start = $($('#menu a')[0]);
            window.predictions = { };
            var startNext = function () {
                predictions[currentSource] = predictions[currentSource] || {}; 
                predictions[currentSource][clicked] = cache[currentSource][clicked].map(function(models){
                    var s = models[model][noise];
                    return [s.relstdev * 100, Math.abs((s.total-solution.total)/solution.total) * 100];
                });
                start = start.next();
                if (start.length) {
                    var name = start.text();
                    genetic.onFinished = function () {
                        if (known > 150 && solution.points.current - solution.points.peak > 5)
                            analyse(startNext);
                        else
                            startNext()
                    }
                    estimate(name);
                }
            }
            startNext();
        }
            
    </script>
</body>
</html>
